<!DOCTYPE html>
<head>
    <title>Church Lower 3rds Control</title>
    <style>
        :root {
            --bg-color: #2b2b2b;
            --container-bg: #3c3c3c;
            --text-color: #e0e0e0;
            --border-color: #555;
            --input-bg: #4a4a4a;
            --button-bg: #007cba;
            --button-hover: #005a87;
            --danger-bg: #dc3545;
            --danger-hover: #c82333;
            --success-bg: #28a745;
            --success-border: #1e7e34;
            --preview-bg: #454545;
            --dropdown-bg: #3c3c3c;
        }

        .light-mode {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: white;
            --button-bg: #007cba;
            --button-hover: #005a87;
            --danger-bg: #dc3545;
            --danger-hover: #c82333;
            --success-bg: #d4edda;
            --success-border: #c3e6cb;
            --preview-bg: #f8f9fa;
            --dropdown-bg: white;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        h1, h2 {
            color: var(--text-color);
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .verse-selector {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .verse-navigation {
            display: grid;
            grid-template-columns: 1fr auto auto auto 1fr;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .nav-button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
        }
        .nav-button:hover {
            background-color: var(--button-hover);
        }
        .nav-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            width: 50px;
            height: 50px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
        }
        .theme-toggle:hover {
            background-color: var(--button-hover);
        }
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            transition: background-color 0.3s;
        }
        .autocomplete-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .autocomplete-item:hover {
            background-color: var(--preview-bg);
        }
        .autocomplete-item.selected {
            background-color: var(--button-bg);
            color: white;
        }
        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button.hide {
            background-color: var(--danger-bg);
        }
        button.hide:hover {
            background-color: var(--danger-hover);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .status.connected {
            background-color: var(--success-bg);
            color: var(--text-color);
            border: 1px solid var(--success-border);
        }
        .status.disconnected {
            background-color: var(--danger-bg);
            color: white;
            border: 1px solid var(--danger-hover);
        }
        .verse-preview {
            background-color: var(--preview-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .verse-preview h3 {
            margin-top: 0;
            color: var(--button-bg);
        }
        .next-verse-preview {
            background-color: var(--container-bg);
            border: 1px solid #555;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            display: none;
            transition: background-color 0.3s, border-color 0.3s;
            opacity: 0.8;
        }
        .next-verse-preview h4 {
            margin: 0 0 8px 0;
            font-size: 0.9em;
        }
        .verse-text {
            font-style: italic;
            line-height: 1.5;
            color: var(--text-color);
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-top: 10px;
            background-color: var(--container-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .search-result {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-color);
        }
        .search-result:hover {
            background-color: var(--preview-bg);
        }
        .search-result:last-child {
            border-bottom: none;
        }
        .verse-reference {
            font-weight: bold;
            color: var(--button-bg);
        }
    </style>
</head>
<body class="light-mode">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>
    
    <div class="status" id="status">Connecting...</div>
    
    <div class="container">
        <h1>Church Lower 3rds Control</h1>
        
        <h2>Bible Verse Display</h2>
        <div class="verse-selector">
            <div class="autocomplete-container">
                <label for="bookInput">Book</label>
                <input type="text" id="bookInput" placeholder="Type book name..." autocomplete="off">
                <div class="autocomplete-dropdown" id="bookDropdown"></div>
            </div>
            
            <div>
                <label for="chapterSelect">Chapter</label>
                <select id="chapterSelect" disabled>
                    <option value="">Select chapter</option>
                </select>
            </div>
            
            <div>
                <label for="verseSelect">Verse</label>
                <select id="verseSelect" disabled>
                    <option value="">Select verse</option>
                </select>
            </div>
        </div>
        
        <div class="quick-verse-input" style="margin: 20px 0; padding: 15px; background: var(--preview-bg); border-radius: 8px;">
            <label for="quickVerseInput"><strong>Quick Verse Input:</strong></label>
            <div style="position: relative;">
                <input type="text" id="quickVerseInput" placeholder="Type: Genesis 1:16 or John 3:16" 
                       style="width: 300px; margin: 5px 0;" 
                       onkeypress="handleQuickVerseKeypress(event)"
                       oninput="handleQuickVerseInput(event)"
                       onkeydown="handleQuickVerseKeydown(event)"
                       autocomplete="off">
                <div id="quickVerseDropdown" class="autocomplete-dropdown" style="width: 300px; display: none;"></div>
            </div>
            <button onclick="parseQuickVerse()" class="verse-button" id="quickVerseGoBtn">Go</button>
            <div id="quickVerseStatus" style="font-size: 12px; margin-top: 5px; min-height: 18px;">
                Format: BookName Chapter:Verse (e.g., "Genesis 1:16", "1 John 3:16", "Psalm 23:1")
            </div>
        </div>
        
        <div class="verse-navigation">
            <div></div>
            <button class="nav-button" onclick="previousVerse()" id="prevBtn" disabled>‚Üê Previous</button>
            <span id="currentVerseRef" style="text-align: center; font-weight: bold;">Select a verse</span>
            <button class="nav-button" onclick="nextVerse()" id="nextBtn" disabled>Next ‚Üí</button>
            <div></div>
        </div>
        
        <div class="verse-preview" id="versePreview">
            <h3 id="verseReference"></h3>
            <div class="verse-text" id="verseText"></div>
        </div>
        
        <div class="next-verse-preview" id="nextVersePreview" style="display: none;">
            <h4 style="color: #888; margin-bottom: 10px;">Next Verse Preview:</h4>
            <h4 id="nextVerseReference" style="color: #aaa; font-size: 0.9em;"></h4>
            <div class="verse-text" id="nextVerseText" style="color: #999; font-size: 0.85em; font-style: italic;"></div>
        </div>
        
        <button onclick="displayVerse()" id="displayBtn" disabled>Display Verse</button>
        <button onclick="hideVerse()" class="hide">Hide Verse</button>
    </div>
    
    <div class="container">
        <h2>Speaker Name</h2>
        <div class="form-group">
            <label for="speakerInput">Speaker Name</label>
            <div class="autocomplete-container">
                <input type="text" id="speakerInput" placeholder="Enter speaker name" oninput="filterSpeakers()" onkeydown="handleSpeakerKeydown(event)">
                <div class="autocomplete-dropdown" id="speakerDropdown"></div>
            </div>
        </div>
        <button onclick="displaySpeaker()">Display Speaker</button>
        <button onclick="hideSpeaker()" class="hide">Hide Speaker</button>
    </div>
    
    <div class="container">
        <h2>Text Search</h2>
        <div class="form-group">
            <label for="searchInput">Search Bible</label>
            <input type="text" id="searchInput" placeholder="Search verses..." oninput="searchBible()">
        </div>
        <div class="search-results" id="searchResults" style="display: none;"></div>
    </div>

    <script>
        let ws;
        let selectedBook = '';
        let selectedChapter = 0;
        let selectedVerse = 0;
        let currentAutocompleteIndex = -1;
        let books = [];
        let speakers = [];
        let currentSpeakerIndex = -1;
        let currentBookData = null;
        let currentVerseData = null;
        
        // Additional variables for consistency
        let currentBook = '';
        let currentChapter = 0;
        let currentVerse = 0;

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Toggle Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-mode');
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Toggle Dark Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                body.classList.remove('light-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Toggle Light Mode';
            } else {
                body.classList.add('light-mode');
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Toggle Dark Mode';
            }
        });

        // Navigation functions
        function previousVerse() {
            console.log('previousVerse called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse === 0) {
                console.log('Cannot go to previous verse - missing selection');
                return;
            }
            
            if (selectedVerse > 1) {
                // Previous verse in same chapter
                console.log('Going to previous verse in same chapter');
                selectVerse(selectedBook, selectedChapter, selectedVerse - 1);
            } else {
                console.log('At beginning of chapter');
            }
        }

        function nextVerse() {
            console.log('nextVerse called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse === 0) {
                console.log('Cannot go to next verse - missing selection');
                return;
            }
            
            // Request the next verse (server will handle chapter boundaries)
            console.log('Requesting next verse from server');
            
            // Send a special request to get the next verse
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_next_verse',
                    book: selectedBook,
                    chapter: selectedChapter,
                    verse: selectedVerse
                }));
            }
        }

        function previousVerse() {
            console.log('previousVerse called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse <= 1) {
                console.log('Cannot go to previous verse - at beginning or missing selection');
                return;
            }
            
            // Go to previous verse
            const prevVerseNum = selectedVerse - 1;
            console.log('Attempting to go to previous verse:', prevVerseNum);
            
            // Update the selection
            selectedVerse = prevVerseNum;
            currentVerse = prevVerseNum;
            
            // Update the verse selector
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.value = prevVerseNum;
            
            // Request the verse AND display it on OBS (not just preview)
            requestVerse(selectedBook, selectedChapter, prevVerseNum);
            
            // Also get preview for the client interface
            requestVersePreview(selectedBook, selectedChapter, prevVerseNum);
            
            updateNavigationButtons();
        }

        function selectVerse(book, chapter, verse) {
            console.log('selectVerse called:', { book, chapter, verse });
            
            selectedBook = book;
            selectedChapter = chapter;
            selectedVerse = verse;
            
            // Update global current variables
            currentBook = book;
            currentChapter = chapter;
            currentVerse = verse;
            
            // Find the book data
            const foundBook = books.find(b => b.abbrev === book || b.name === book);
            if (!foundBook) {
                console.error('Book not found:', book);
                return;
            }
            
            // Update the book input field
            const bookInput = document.getElementById('bookInput');
            bookInput.value = foundBook.name;
            
            // Update the chapter selector
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.value = chapter;
            chapterSelect.disabled = false;
            
            // Update the verse selector  
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.value = verse;
            verseSelect.disabled = false;
            
            // Request and preview the verse
            console.log('Requesting verse preview for:', foundBook.abbrev || foundBook.name, chapter, verse);
            requestVersePreview(foundBook.abbrev || foundBook.name, chapter, verse);
        }

        function extractBookFromName(verseName) {
            // Extract book name from verse name like "Genesis 1:2"
            if (verseName && verseName.includes(' ')) {
                const parts = verseName.split(' ');
                // Return everything except the last part (which is chapter:verse)
                return parts.slice(0, -1).join(' ');
            }
            return selectedBook; // Fallback to current book
        }

        function updateUIForNewVerse(book, chapter, verse) {
            // Update book input
            const foundBook = books.find(b => b.abbrev === book || b.name === book);
            if (foundBook) {
                const bookInput = document.getElementById('bookInput');
                bookInput.value = foundBook.name;
            }
            
            // Update chapter selector
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.value = chapter;
            chapterSelect.disabled = false;
            
            // Update verse selector
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.value = verse;
            verseSelect.disabled = false;
            
            // Update navigation buttons
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentRef = document.getElementById('currentVerseRef');
            
            console.log('updateNavigationButtons called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse === 0) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                currentRef.textContent = 'Select a verse';
                console.log('Navigation buttons disabled - missing data');
                return;
            }
            
            // Update the current reference display
            currentRef.textContent = `Current: ${selectedBook} ${selectedChapter}:${selectedVerse}`;
            
            // Enable/disable buttons based on simple logic
            const canGoPrev = selectedVerse > 1;
            prevBtn.disabled = !canGoPrev;
            
            // Update button text to show next/previous verse numbers
            if (canGoPrev) {
                prevBtn.textContent = `‚Üê ${selectedBook} ${selectedChapter}:${selectedVerse - 1}`;
            } else {
                prevBtn.textContent = '‚Üê Previous Verse';
            }
            
            // For next button, always enable it and show next verse number
            nextBtn.disabled = false;
            nextBtn.textContent = `${selectedBook} ${selectedChapter}:${selectedVerse + 1} ‚Üí`;
            
            console.log('Navigation buttons updated:', {
                canGoPrev,
                prevDisabled: prevBtn.disabled,
                nextDisabled: nextBtn.disabled,
                nextVerse: selectedVerse + 1
            });
        }

        function connect() {
            ws = new WebSocket('ws://localhost:8080/ws/control');
            
            ws.onopen = function() {
                console.log('Connected to server');
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connected to server';
                
                // Load initial book list
                requestBooks();
                
                // Load speakers list
                requestSpeakers();
            };
            
            ws.onclose = function() {
                console.log('Disconnected from server');
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'Disconnected from server - Retrying...';
                setTimeout(connect, 3000);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'books_response':
                        handleBooksResponse(data.books);
                        break;
                    case 'chapters_response':
                        handleChaptersResponse(data.chapters);
                        break;
                    case 'verses_response':
                        handleVersesResponse(data.verses);
                        break;
                    case 'search_results':
                        handleSearchResults(data.results);
                        break;
                    case 'verse_preview':
                        if (data.verse) {
                            showVersePreview(data.verse);
                        } else {
                            console.log('Verse not found, cannot navigate further');
                            // Revert the verse selection if the verse doesn't exist
                            if (selectedVerse > 1) {
                                selectedVerse = selectedVerse - 1;
                                currentVerse = selectedVerse;
                                // Update the verse selector back
                                const verseSelect = document.getElementById('verseSelect');
                                verseSelect.value = selectedVerse;
                            }
                        }
                        break;
                    case 'next_verse_preview':
                        if (data.verse) {
                            showNextVersePreview(data.verse);
                        } else {
                            hideNextVersePreview();
                        }
                        break;
                    case 'next_verse_response':
                        if (data.verse) {
                            // Successfully got next verse, update our current selection
                            const verse = data.verse;
                            console.log('Received next verse:', verse);
                            
                            // Update selection variables
                            selectedBook = extractBookFromName(verse.name);
                            selectedChapter = verse.chapter;
                            selectedVerse = verse.verse;
                            currentBook = selectedBook;
                            currentChapter = selectedChapter;
                            currentVerse = selectedVerse;
                            
                            // Update UI selectors
                            updateUIForNewVerse(selectedBook, selectedChapter, selectedVerse);
                            
                            // Show verse preview
                            showVersePreview(verse);
                            
                            console.log('Navigation successful to:', selectedBook, selectedChapter, selectedVerse);
                        } else {
                            console.log('No next verse available (end of book?)');
                        }
                        break;
                    case 'speakers_response':
                        handleSpeakersResponse(data.speakers);
                        break;
                }
            };
        }

        function requestBooks(filter = '') {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_books',
                    filter: filter
                }));
            }
        }

        function requestChapters(book) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_chapters',
                    book: book
                }));
            }
        }

        function requestVerses(book, chapter) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_verses',
                    book: book,
                    chapter: chapter
                }));
            }
        }

        function requestVerse(book, chapter, verse) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_verse',
                    book: book,
                    chapter: chapter,
                    verse: verse
                }));
            }
        }

        function requestVersePreview(book, chapter, verse) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'preview_verse',
                    book: book,
                    chapter: chapter,
                    verse: verse
                }));
            }
        }

        function requestNextVersePreview(book, chapter, verse) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'preview_next_verse',
                    book: book,
                    chapter: chapter,
                    verse: verse
                }));
            }
        }

        function requestSpeakers(filter = '') {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_speakers',
                    filter: filter
                }));
            }
        }

        function handleBooksResponse(bookList) {
            books = bookList;
            showBookDropdown(bookList);
            
            // Handle pending quick selection
            if (pendingQuickSelection) {
                const { bookName, chapter, verse } = pendingQuickSelection;
                
                // Find matching book (case insensitive, flexible matching)
                const matchedBook = bookList.find(book => 
                    book.toLowerCase().includes(bookName.toLowerCase()) ||
                    bookName.toLowerCase().includes(book.toLowerCase())
                );
                
                if (matchedBook) {
                    // Set the book
                    selectedBook = matchedBook;
                    currentBook = matchedBook;
                    document.getElementById('bookInput').value = matchedBook;
                    
                    // Request chapters for this book
                    requestChapters(matchedBook);
                    
                    // Store the chapter and verse to select after chapters load
                    pendingQuickSelection = { ...pendingQuickSelection, bookName: matchedBook };
                } else {
                    const status = document.getElementById('quickVerseStatus');
                    if (status) {
                        status.innerHTML = `‚ùå Book "${bookName}" not found. Please check the spelling.`;
                        status.style.color = '#dc3545';
                    }
                    pendingQuickSelection = null;
                }
            }
        }

        function handleChaptersResponse(chapters) {
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.innerHTML = '<option value="">Select chapter</option>';
            
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
            
            chapterSelect.disabled = false;
            document.getElementById('verseSelect').disabled = true;
            document.getElementById('verseSelect').innerHTML = '<option value="">Select verse</option>';
            hideVersePreview();
            
            // Handle pending quick selection
            if (pendingQuickSelection) {
                const { chapter, verse } = pendingQuickSelection;
                
                // Check if the requested chapter exists
                if (chapters.includes(chapter)) {
                    // Set the chapter
                    selectedChapter = chapter;
                    currentChapter = chapter;
                    chapterSelect.value = chapter;
                    
                    // Request verses for this chapter
                    requestVerses(selectedBook, chapter);
                    
                    // Keep the verse selection for when verses load
                } else {
                    const status = document.getElementById('quickVerseStatus');
                    if (status) {
                        status.innerHTML = `‚ùå Chapter ${chapter} not found in ${selectedBook}.`;
                        status.style.color = '#dc3545';
                    }
                    pendingQuickSelection = null;
                }
            }
        }

        function handleVersesResponse(verses) {
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.innerHTML = '<option value="">Select verse</option>';
            
            verses.forEach(verse => {
                const option = document.createElement('option');
                option.value = verse;
                option.textContent = verse;
                verseSelect.appendChild(option);
            });
            
            verseSelect.disabled = false;
            hideVersePreview();
            
            // Handle pending quick selection
            if (pendingQuickSelection) {
                const { verse } = pendingQuickSelection;
                const status = document.getElementById('quickVerseStatus');
                
                // Check if the requested verse exists
                if (verses.includes(verse)) {
                    // Set the verse
                    selectedVerse = verse;
                    currentVerse = verse;
                    verseSelect.value = verse;
                    
                    // Request the verse preview
                    requestVersePreview(selectedBook, selectedChapter, verse);
                    
                    // Clear the quick input and show success
                    document.getElementById('quickVerseInput').value = '';
                    if (status) {
                        status.innerHTML = '‚úÖ Verse found and selected!';
                        status.style.color = '#28a745';
                        setTimeout(() => {
                            status.innerHTML = 'Format: BookName Chapter:Verse (e.g., "Genesis 1:16", "1 John 3:16", "Psalm 23:1")';
                            status.style.color = 'var(--text-color)';
                        }, 2000);
                    }
                } else {
                    if (status) {
                        status.innerHTML = `‚ùå Verse ${verse} not found in ${selectedBook} ${selectedChapter}.`;
                        status.style.color = '#dc3545';
                    }
                }
                
                pendingQuickSelection = null;
            }
        }

        function handleSpeakersResponse(speakerList) {
            speakers = speakerList;
            showSpeakerDropdown(speakerList);
        }

        function showSpeakerDropdown(speakerList) {
            const dropdown = document.getElementById('speakerDropdown');
            dropdown.innerHTML = '';
            
            if (speakerList.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            speakerList.slice(0, 10).forEach((speaker, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = speaker;
                item.addEventListener('click', () => {
                    selectSpeaker(speaker);
                });
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
            currentSpeakerIndex = -1;
        }

        function selectSpeaker(speaker) {
            document.getElementById('speakerInput').value = speaker;
            document.getElementById('speakerDropdown').style.display = 'none';
            currentSpeakerIndex = -1;
        }

        function filterSpeakers() {
            const input = document.getElementById('speakerInput');
            const filter = input.value;
            
            if (filter.length > 0) {
                requestSpeakers(filter);
            } else {
                document.getElementById('speakerDropdown').style.display = 'none';
            }
        }

        function handleSpeakerKeydown(event) {
            const dropdown = document.getElementById('speakerDropdown');
            const items = dropdown.getElementsByClassName('autocomplete-item');
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                currentSpeakerIndex = Math.min(currentSpeakerIndex + 1, items.length - 1);
                updateSpeakerSelection(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                currentSpeakerIndex = Math.max(currentSpeakerIndex - 1, -1);
                updateSpeakerSelection(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (currentSpeakerIndex >= 0 && items[currentSpeakerIndex]) {
                    selectSpeaker(items[currentSpeakerIndex].textContent);
                }
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
                currentSpeakerIndex = -1;
            }
        }

        function updateSpeakerSelection(items) {
            Array.from(items).forEach((item, index) => {
                if (index === currentSpeakerIndex) {
                    item.style.backgroundColor = 'var(--button-bg)';
                    item.style.color = 'white';
                } else {
                    item.style.backgroundColor = '';
                    item.style.color = '';
                }
            });
        }

        function handleSearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (results.length > 0) {
                searchResults.style.display = 'block';
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'search-result';
                    
                    // Handle new structure where result.name contains the reference
                    let verseReference;
                    if (result.name) {
                        verseReference = result.name;
                    } else if (result.book) {
                        verseReference = `${result.book} ${result.chapter}:${result.verse}`;
                    } else {
                        verseReference = `Chapter ${result.chapter}:${result.verse}`;
                    }
                    
                    div.innerHTML = `
                        <div class="verse-reference">${verseReference}</div>
                        <div class="verse-text">${result.text}</div>
                    `;
                    div.onclick = () => selectSearchResult(result);
                    searchResults.appendChild(div);
                });
            } else {
                searchResults.style.display = 'none';
            }
        }

        function selectSearchResult(result) {
            // Extract book name from result.name (e.g., "John 3:16" -> "John")
            let bookName;
            if (result.name) {
                // Parse the book name from the reference string
                const parts = result.name.split(' ');
                // Handle cases like "I John 3:16", "II Peter 1:1", etc.
                if (parts.length >= 2 && (parts[0] === 'I' || parts[0] === 'II' || parts[0] === 'III')) {
                    bookName = parts[0] + ' ' + parts[1];
                } else {
                    bookName = parts[0];
                }
            } else if (result.book) {
                bookName = result.book;
            } else {
                console.error('No book name found in search result');
                return;
            }
            
            // Set the book, chapter, and verse selections
            document.getElementById('bookInput').value = bookName;
            selectedBook = bookName;
            currentBook = bookName;
            
            // Request chapters for this book
            requestChapters(bookName);
            
            // Set chapter and verse when chapters load
            setTimeout(() => {
                document.getElementById('chapterSelect').value = result.chapter;
                selectedChapter = result.chapter;
                currentChapter = result.chapter;
                
                // Request verses for this chapter
                requestVerses(bookName, result.chapter);
                
                // Set verse when verses load
                setTimeout(() => {
                    document.getElementById('verseSelect').value = result.verse;
                    selectedVerse = result.verse;
                    currentVerse = result.verse;
                    showVersePreview(result);
                    updateNavigationButtons();
                }, 100);
            }, 100);
            
            hideBookDropdown();
            document.getElementById('searchResults').style.display = 'none';
        }

        function showBookDropdown(bookList) {
            const dropdown = document.getElementById('bookDropdown');
            dropdown.innerHTML = '';
            
            bookList.forEach((book, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                if (index === currentAutocompleteIndex) {
                    div.classList.add('selected');
                }
                div.textContent = book;
                div.onclick = () => selectBook(book);
                dropdown.appendChild(div);
            });
            
            dropdown.style.display = bookList.length > 0 ? 'block' : 'none';
        }

        function hideBookDropdown() {
            document.getElementById('bookDropdown').style.display = 'none';
            currentAutocompleteIndex = -1;
        }

        function displayBookSuggestions(books) {
            const bookDropdown = document.getElementById('bookDropdown');
            if (books.length === 0) {
                bookDropdown.innerHTML = '<div class="dropdown-item">No books found</div>';
            } else {
                bookDropdown.innerHTML = books.map(book => 
                    `<div class="dropdown-item" onclick="selectBook('${book}')">${book}</div>`
                ).join('');
            }
            bookDropdown.style.display = 'block';
        }

        function selectBook(bookName) {
            console.log('Selecting book:', bookName); // Debug log
            if (!bookName || bookName === 'undefined') {
                console.error('Invalid book name:', bookName);
                return;
            }
            
            const bookDropdown = document.getElementById('bookDropdown');
            document.getElementById('bookInput').value = bookName;
            bookDropdown.style.display = 'none';
            
            currentBook = bookName;
            selectedBook = bookName;
            currentChapter = 0;
            selectedChapter = 0;
            currentVerse = 0;
            selectedVerse = 0;
            currentBookData = null;
            
            // Reset chapter and verse dropdowns
            document.getElementById('chapterSelect').innerHTML = '<option value="">Select Chapter</option>';
            document.getElementById('verseSelect').innerHTML = '<option value="">Select Verse</option>';
            
            // Request chapters for this book
            const message = {
                type: 'get_chapters',
                book: bookName
            };
            
            ws.send(JSON.stringify(message));
            updateNavigationButtons();
        }

        function showVersePreview(verse) {
            // Always show book, chapter, and verse information clearly
            let verseReference;
            let bookName = selectedBook;
            let chapterNum = verse.chapter || selectedChapter;
            let verseNum = verse.verse || selectedVerse;
            
            // Handle both old format (with book property) and new format (with name property)
            if (verse.name) {
                verseReference = verse.name; // Use the name field from new JSON structure
                // Extract book name from the name field if available
                const nameParts = verse.name.split(' ');
                if (nameParts.length >= 2) {
                    const refPart = nameParts[nameParts.length - 1]; // Get the last part (chapter:verse)
                    bookName = nameParts.slice(0, -1).join(' '); // Everything except the last part
                }
            } else if (verse.book) {
                verseReference = `${verse.book} ${chapterNum}:${verseNum}`;
                bookName = verse.book;
            } else {
                verseReference = `${bookName} ${chapterNum}:${verseNum}`;
            }
            
            // Store current verse data for display
            currentVerseData = verse;
            
            // Update the preview display with clear formatting
            document.getElementById('verseReference').textContent = verseReference;
            document.getElementById('verseText').textContent = verse.text;
            document.getElementById('versePreview').style.display = 'block';
            document.getElementById('displayBtn').disabled = false;
            
            // Update the current verse reference in navigation area
            const currentRef = document.getElementById('currentVerseRef');
            if (currentRef) {
                currentRef.textContent = `Current: ${bookName} ${chapterNum}:${verseNum}`;
            }
            
            console.log('Verse preview updated:', {
                reference: verseReference,
                book: bookName,
                chapter: chapterNum,
                verse: verseNum,
                text: verse.text.substring(0, 50) + '...'
            });
            
            // Update navigation buttons when verse is shown
            updateNavigationButtons();
            
            // Request next verse preview automatically
            if (selectedBook && selectedChapter && selectedVerse) {
                requestNextVersePreview(selectedBook, selectedChapter, selectedVerse);
            }
        }

        function hideVersePreview() {
            document.getElementById('versePreview').style.display = 'none';
            document.getElementById('displayBtn').disabled = true;
            hideNextVersePreview();
        }

        function showNextVersePreview(verse) {
            // Extract verse information
            let verseReference;
            let bookName = selectedBook;
            let chapterNum = verse.chapter || selectedChapter;
            let verseNum = verse.verse || selectedVerse;
            
            // Handle both old format (with book property) and new format (with name property)
            if (verse.name) {
                verseReference = verse.name;
                // Extract book name from the name field if available
                const nameParts = verse.name.split(' ');
                if (nameParts.length >= 2) {
                    const refPart = nameParts[nameParts.length - 1];
                    bookName = nameParts.slice(0, -1).join(' ');
                }
            } else if (verse.book) {
                verseReference = `${verse.book} ${chapterNum}:${verseNum}`;
                bookName = verse.book;
            } else {
                verseReference = `${bookName} ${chapterNum}:${verseNum}`;
            }
            
            // Update the next verse preview display
            document.getElementById('nextVerseReference').textContent = verseReference;
            document.getElementById('nextVerseText').textContent = verse.text;
            document.getElementById('nextVersePreview').style.display = 'block';
            
            console.log('Next verse preview updated:', {
                reference: verseReference,
                text: verse.text.substring(0, 50) + '...'
            });
        }

        function hideNextVersePreview() {
            document.getElementById('nextVersePreview').style.display = 'none';
        }

        function searchBible() {
            const query = document.getElementById('searchInput').value;
            if (query.trim() && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'search',
                    query: query
                }));
            } else {
                document.getElementById('searchResults').style.display = 'none';
            }
        }

        function displayVerse() {
            if (selectedBook && selectedChapter && selectedVerse) {
                requestVerse(selectedBook, selectedChapter, selectedVerse);
            }
        }

        function hideVerse() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'bible',
                    show: false
                }));
            }
        }

        function displaySpeaker() {
            const speaker = document.getElementById('speakerInput').value;
            if (speaker && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'speaker',
                    speaker: speaker,
                    show: true
                }));
            }
        }

        function hideSpeaker() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'speaker',
                    show: false
                }));
            }
        }

        // Book input event handlers
        document.getElementById('bookInput').addEventListener('input', function() {
            const filter = this.value;
            currentAutocompleteIndex = -1;
            if (filter.trim()) {
                requestBooks(filter);
            } else {
                hideBookDropdown();
            }
        });

        document.getElementById('bookInput').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('bookDropdown');
            const items = dropdown.children;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentAutocompleteIndex = Math.min(currentAutocompleteIndex + 1, items.length - 1);
                updateDropdownSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentAutocompleteIndex = Math.max(currentAutocompleteIndex - 1, -1);
                updateDropdownSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentAutocompleteIndex >= 0 && items[currentAutocompleteIndex]) {
                    selectBook(items[currentAutocompleteIndex].textContent);
                }
            } else if (e.key === 'Escape') {
                hideBookDropdown();
            }
        });

        document.getElementById('bookInput').addEventListener('blur', function() {
            // Delay hiding to allow click events
            setTimeout(hideBookDropdown, 100);
        });

        function updateDropdownSelection() {
            const items = document.getElementById('bookDropdown').children;
            for (let i = 0; i < items.length; i++) {
                items[i].classList.toggle('selected', i === currentAutocompleteIndex);
            }
        }

        // Chapter select handler
        document.getElementById('chapterSelect').addEventListener('change', function() {
            selectedChapter = parseInt(this.value);
            currentChapter = selectedChapter;
            selectedVerse = 0; // Reset verse selection
            currentVerse = 0;
            if (selectedChapter && selectedBook) {
                requestVerses(selectedBook, selectedChapter);
            } else {
                document.getElementById('verseSelect').disabled = true;
                document.getElementById('verseSelect').innerHTML = '<option value="">Select verse</option>';
                hideVersePreview();
            }
            updateNavigationButtons();
        });

        // Verse select handler  
        document.getElementById('verseSelect').addEventListener('change', function() {
            selectedVerse = parseInt(this.value);
            currentVerse = selectedVerse;
            if (selectedVerse && selectedBook && selectedChapter) {
                // Request the actual verse text for preview
                requestVersePreview(selectedBook, selectedChapter, selectedVerse);
                updateNavigationButtons();
            } else {
                hideVersePreview();
                updateNavigationButtons();
            }
        });

        // Quick verse input functions
        let quickVerseAutocompleteIndex = -1;
        let quickVerseSuggestions = [];
        
        function handleQuickVerseKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (quickVerseAutocompleteIndex >= 0 && quickVerseSuggestions.length > 0) {
                    selectQuickVerseSuggestion(quickVerseSuggestions[quickVerseAutocompleteIndex]);
                } else {
                    parseQuickVerse();
                }
            }
        }

        function handleQuickVerseKeydown(event) {
            const dropdown = document.getElementById('quickVerseDropdown');
            if (dropdown.style.display === 'block') {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    quickVerseAutocompleteIndex = Math.min(quickVerseAutocompleteIndex + 1, quickVerseSuggestions.length - 1);
                    updateQuickVerseSelection();
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    quickVerseAutocompleteIndex = Math.max(quickVerseAutocompleteIndex - 1, -1);
                    updateQuickVerseSelection();
                } else if (event.key === 'Escape') {
                    hideQuickVerseDropdown();
                }
            }
        }

        function handleQuickVerseInput(event) {
            const input = event.target.value;
            const status = document.getElementById('quickVerseStatus');
            const goBtn = document.getElementById('quickVerseGoBtn');
            
            // Real-time validation and autocomplete
            if (!input.trim()) {
                status.innerHTML = 'Format: BookName Chapter:Verse (e.g., "Genesis 1:16", "1 John 3:16", "Psalm 23:1")';
                status.style.color = 'var(--text-color)';
                goBtn.disabled = false;
                hideQuickVerseDropdown();
                return;
            }

            // Check for valid characters only (letters, numbers, spaces, colon)
            const validChars = /^[a-zA-Z0-9\s:]*$/;
            if (!validChars.test(input)) {
                status.innerHTML = '‚ùå Only letters, numbers, spaces, and colon (:) allowed';
                status.style.color = '#dc3545';
                goBtn.disabled = true;
                hideQuickVerseDropdown();
                return;
            }

            // Parse current input state
            const colonIndex = input.indexOf(':');
            const lastSpaceIndex = input.lastIndexOf(' ');
            
            if (colonIndex === -1) {
                // Still typing book name or chapter
                if (lastSpaceIndex === -1) {
                    // Still typing book name
                    showBookSuggestions(input);
                    status.innerHTML = 'üí° Type book name... (e.g., Genesis, John, Psalm)';
                    status.style.color = 'var(--button-bg)';
                    goBtn.disabled = true;
                } else {
                    // Has space, might be typing chapter
                    const bookPart = input.substring(0, lastSpaceIndex);
                    const chapterPart = input.substring(lastSpaceIndex + 1);
                    
                    if (!/^\d*$/.test(chapterPart)) {
                        status.innerHTML = '‚ùå Chapter must be a number';
                        status.style.color = '#dc3545';
                        goBtn.disabled = true;
                        hideQuickVerseDropdown();
                    } else {
                        showBookSuggestions(bookPart);
                        status.innerHTML = `üí° Add colon and verse number (e.g., "${input}:1")`;
                        status.style.color = 'var(--button-bg)';
                        goBtn.disabled = true;
                    }
                }
            } else {
                // Has colon, check verse number
                const beforeColon = input.substring(0, colonIndex);
                const afterColon = input.substring(colonIndex + 1);
                
                if (!/^\d*$/.test(afterColon)) {
                    status.innerHTML = '‚ùå Verse must be a number';
                    status.style.color = '#dc3545';
                    goBtn.disabled = true;
                } else if (afterColon === '') {
                    status.innerHTML = 'üí° Type verse number';
                    status.style.color = 'var(--button-bg)';
                    goBtn.disabled = true;
                } else {
                    // Valid format
                    const regex = /^(.+?)\s+(\d+):(\d+)$/;
                    if (regex.test(input)) {
                        status.innerHTML = '‚úÖ Valid format! Press Enter or click Go';
                        status.style.color = '#28a745';
                        goBtn.disabled = false;
                    } else {
                        status.innerHTML = 'üí° Almost there... (BookName Chapter:Verse)';
                        status.style.color = 'var(--button-bg)';
                        goBtn.disabled = true;
                    }
                }
                hideQuickVerseDropdown();
            }
        }

        function showBookSuggestions(input) {
            if (!books || books.length === 0 || !input.trim()) {
                hideQuickVerseDropdown();
                return;
            }

            const filter = input.toLowerCase().trim();
            const suggestions = books.filter(book => 
                book.toLowerCase().includes(filter)
            ).slice(0, 8); // Show max 8 suggestions

            if (suggestions.length === 0) {
                hideQuickVerseDropdown();
                return;
            }

            quickVerseSuggestions = suggestions;
            quickVerseAutocompleteIndex = -1;
            
            const dropdown = document.getElementById('quickVerseDropdown');
            dropdown.innerHTML = '';
            
            suggestions.forEach((book, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = book;
                item.addEventListener('click', () => selectQuickVerseSuggestion(book));
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        function selectQuickVerseSuggestion(book) {
            const input = document.getElementById('quickVerseInput');
            const currentValue = input.value;
            const lastSpaceIndex = currentValue.lastIndexOf(' ');
            
            if (lastSpaceIndex === -1) {
                // Replace entire input with book name
                input.value = book + ' ';
            } else {
                // Replace just the book part
                const afterSpace = currentValue.substring(lastSpaceIndex + 1);
                if (/^\d/.test(afterSpace)) {
                    // Keep the chapter part
                    input.value = book + ' ' + afterSpace;
                } else {
                    // Replace the partial book name
                    input.value = book + ' ';
                }
            }
            
            hideQuickVerseDropdown();
            input.focus();
            
            // Trigger input event to update validation
            const event = new Event('input', { bubbles: true });
            input.dispatchEvent(event);
        }

        function updateQuickVerseSelection() {
            const items = document.getElementById('quickVerseDropdown').children;
            for (let i = 0; i < items.length; i++) {
                items[i].classList.toggle('selected', i === quickVerseAutocompleteIndex);
            }
        }

        function hideQuickVerseDropdown() {
            document.getElementById('quickVerseDropdown').style.display = 'none';
            quickVerseAutocompleteIndex = -1;
            quickVerseSuggestions = [];
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const quickInput = document.getElementById('quickVerseInput');
            const quickDropdown = document.getElementById('quickVerseDropdown');
            if (!quickInput.contains(event.target) && !quickDropdown.contains(event.target)) {
                hideQuickVerseDropdown();
            }
        });

        function parseQuickVerse() {
            const input = document.getElementById('quickVerseInput').value.trim();
            const status = document.getElementById('quickVerseStatus');
            
            if (!input) return;

            // Parse different formats like "Genesis 1:16", "1 John 3:16", "Psalm 23:1"
            const regex = /^(.+?)\s+(\d+):(\d+)$/;
            const match = input.match(regex);
            
            if (!match) {
                status.innerHTML = '‚ùå Please use format: BookName Chapter:Verse (e.g., "Genesis 1:16")';
                status.style.color = '#dc3545';
                return;
            }

            const bookName = match[1].trim();
            const chapter = parseInt(match[2]);
            const verse = parseInt(match[3]);

            // Show loading status
            status.innerHTML = 'üîç Searching for verse...';
            status.style.color = 'var(--button-bg)';

            // Set the selections
            selectBookByName(bookName, chapter, verse);
        }

        function selectBookByName(bookName, chapter, verse) {
            // First, request all books to find a match
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_books',
                    filter: ''
                }));
                
                // Store the target for when books are received
                pendingQuickSelection = { bookName, chapter, verse };
            }
        }

        let pendingQuickSelection = null;

        // Connect on page load
        connect();
    </script>
</body>
</html>

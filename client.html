<!DOCTYPE html>
<head>
    <title>Church Lower 3rds Control</title>
    <style>
        :root {
            --bg-color: #2b2b2b;
            --container-bg: #3c3c3c;
            --text-color: #e0e0e0;
            --border-color: #555;
            --input-bg: #4a4a4a;
            --button-bg: #007cba;
            --button-hover: #005a87;
            --danger-bg: #dc3545;
            --danger-hover: #c82333;
            --success-bg: #28a745;
            --success-border: #1e7e34;
            --preview-bg: #454545;
            --dropdown-bg: #3c3c3c;
        }

        .light-mode {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: white;
            --button-bg: #007cba;
            --button-hover: #005a87;
            --danger-bg: #dc3545;
            --danger-hover: #c82333;
            --success-bg: #d4edda;
            --success-border: #c3e6cb;
            --preview-bg: #f8f9fa;
            --dropdown-bg: white;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        h1, h2 {
            color: var(--text-color);
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .verse-selector {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .verse-navigation {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto 1fr;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .auto-advance-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .auto-advance-btn.active {
            background-color: var(--success-bg);
        }
        .nav-button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
        }
        .nav-button:hover {
            background-color: var(--button-hover);
        }
        .nav-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            width: 50px;
            height: 50px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
        }
        .theme-toggle:hover {
            background-color: var(--button-hover);
        }
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            transition: background-color 0.3s;
        }
        .autocomplete-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .autocomplete-item:hover {
            background-color: var(--preview-bg);
        }
        .autocomplete-item.selected {
            background-color: var(--button-bg);
            color: white;
        }
        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button.hide {
            background-color: var(--danger-bg);
        }
        button.hide:hover {
            background-color: var(--danger-hover);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .status.connected {
            background-color: var(--success-bg);
            color: var(--text-color);
            border: 1px solid var(--success-border);
        }
        .status.disconnected {
            background-color: var(--danger-bg);
            color: white;
            border: 1px solid var(--danger-hover);
        }
        .verse-preview {
            background-color: var(--preview-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .verse-preview h3 {
            margin-top: 0;
            color: var(--button-bg);
        }
        .next-verse-preview {
            background-color: var(--container-bg);
            border: 1px solid #555;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            display: none;
            transition: background-color 0.3s, border-color 0.3s;
            opacity: 0.8;
        }
        .next-verse-preview h4 {
            margin: 0 0 8px 0;
            font-size: 0.9em;
        }
        .verse-text {
            font-style: italic;
            line-height: 1.5;
            color: var(--text-color);
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-top: 10px;
            background-color: var(--container-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .search-result {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-color);
        }
        .search-result:hover {
            background-color: var(--preview-bg);
        }
        .search-result:last-child {
            border-bottom: none;
        }
        .verse-reference {
            font-weight: bold;
            color: var(--button-bg);
        }
        
        /* Sermon Suggestion Styles */
        .suggestion-item {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            position: relative;
        }
        
        .suggestion-item:hover {
            background: var(--preview-bg);
            border-color: var(--button-bg);
            transform: translateX(2px);
        }
        
        .suggestion-item.suggestion-direct-reference {
            border-left: 4px solid var(--button-bg);
            background: linear-gradient(90deg, var(--preview-bg) 20%, var(--container-bg) 20%);
        }

        .suggestion-item.suggestion-keyword-based {
            border-left: 4px solid var(--success-bg);
        }
        
        .suggestion-ref {
            font-weight: bold;
            color: var(--button-bg);
            margin-bottom: 3px;
        }
        
        .suggestion-text {
            color: var(--text-color);
            font-style: italic;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .suggestion-keywords {
            font-size: 11px;
            color: var(--button-bg);
            margin-top: 3px;
            opacity: 0.7;
        }
        
        .timestamp {
            font-weight: normal;
            opacity: 0.8;
            font-style: italic;
        }
        
        .listening-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="light-mode">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>
    
    <div class="status" id="status">Connecting...</div>
    
    <div class="container">
        <h1>Church Lower 3rds Control</h1>
        
        <div class="container" style="background: linear-gradient(135deg, var(--container-bg) 0%, var(--preview-bg) 100%); border: 2px solid var(--button-bg);">
            <h2>üé§ Live Sermon Scripture Suggestions</h2>
            <div class="form-group">
                <button id="listenBtn" onclick="toggleListening()">üé§ Start Listening</button>
                <button id="testMicBtn" onclick="testMicrophone()" style="margin-left: 10px; background-color: #6c757d;">üîç Test Mic</button>
                <div id="listeningStatus" style="margin: 10px 0; font-style: italic; color: #666; min-height: 40px; font-size: 13px;">Not listening</div>
            </div>
            
            <div id="transcriptionBox" style="background: var(--preview-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; margin: 10px 0; min-height: 60px; font-size: 12px; color: var(--text-color); display: none;">
                <strong>Recent Speech:</strong>
                <div id="transcriptionText" style="margin-top: 5px; font-style: italic;"></div>
            </div>
            
            <div id="suggestionsList" style="display: none;">
                <h3 style="margin: 15px 0 10px 0; font-size: 14px; color: var(--button-bg);">Scripture Suggestions:</h3>
                <div id="suggestions" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>

        <h2>Bible Verse Display</h2>
        <div class="verse-selector">
            <div class="autocomplete-container">
                <label for="bookInput">Book</label>
                <input type="text" id="bookInput" placeholder="Type book name..." autocomplete="off">
                <div class="autocomplete-dropdown" id="bookDropdown"></div>
            </div>
            
            <div>
                <label for="chapterSelect">Chapter</label>
                <select id="chapterSelect" disabled>
                    <option value="">Select chapter</option>
                </select>
            </div>
            
            <div>
                <label for="verseSelect">Verse</label>
                <select id="verseSelect" disabled>
                    <option value="">Select verse</option>
                </select>
            </div>
        </div>
        
        <div class="quick-verse-input" style="margin: 20px 0; padding: 15px; background: var(--preview-bg); border-radius: 8px;">
            <label for="quickVerseInput"><strong>Quick Verse Input:</strong></label>
            <div style="position: relative;">
                <input type="text" id="quickVerseInput" placeholder="Type: Genesis 1:16 or John 3:16" 
                       style="width: 300px; margin: 5px 0;" 
                       onkeypress="handleQuickVerseKeypress(event)"
                       oninput="handleQuickVerseInput(event)"
                       onkeydown="handleQuickVerseKeydown(event)"
                       autocomplete="off">
                <div id="quickVerseDropdown" class="autocomplete-dropdown" style="width: 300px; display: none;"></div>
            </div>
            <button onclick="parseQuickVerse()" class="verse-button" id="quickVerseGoBtn">Go</button>
            <div id="quickVerseStatus" style="font-size: 12px; margin-top: 5px; min-height: 18px;">
                Format: BookName Chapter:Verse (e.g., "Genesis 1:16", "1 John 3:16", "Psalm 23:1")
            </div>
        </div>
        
        <div class="verse-navigation">
            <div></div>
            <button class="nav-button" onclick="previousVerse()" id="prevBtn" disabled>‚Üê Previous</button>
            <span id="currentVerseRef" style="text-align: center; font-weight: bold;">Select a verse</span>
            <button class="nav-button" onclick="nextVerse()" id="nextBtn" disabled>Next ‚Üí</button>
            <button class="auto-advance-btn" id="autoAdvanceBtn" onclick="toggleAutoAdvance()" title="Automatically advance to the next verse when the speaker reads it.">Auto-Advance</button>
            <div></div>
        </div>
        
        <div class="verse-preview" id="versePreview">
            <h3 id="verseReference"></h3>
            <div class="verse-text" id="verseText"></div>
        </div>
        
        <div class="next-verse-preview" id="nextVersePreview" style="display: none;">
            <h4 style="color: #888; margin-bottom: 10px;">Next Verse Preview:</h4>
            <h4 id="nextVerseReference" style="color: #aaa; font-size: 0.9em;"></h4>
            <div class="verse-text" id="nextVerseText" style="color: #999; font-size: 0.85em; font-style: italic;"></div>
        </div>
        
        <button onclick="displayVerse()" id="displayBtn" disabled>Display Verse</button>
        <button onclick="hideVerse()" class="hide">Hide Verse</button>
    </div>
    
    <div class="container">
        <h2>Speaker Name</h2>
        <div class="form-group">
            <label for="speakerInput">Speaker Name</label>
            <div class="autocomplete-container">
                <input type="text" id="speakerInput" placeholder="Enter speaker name" oninput="filterSpeakers()" onkeydown="handleSpeakerKeydown(event)">
                <div class="autocomplete-dropdown" id="speakerDropdown"></div>
            </div>
        </div>
        <button onclick="displaySpeaker()">Display Speaker</button>
        <button onclick="hideSpeaker()" class="hide">Hide Speaker</button>
    </div>

    <div class="container">
        <h2>Countdown Timer</h2>
        <div class="form-group">
            <label>Presets</label>
            <button onclick="setCountdownPreset('09:45')">9:45 AM</button>
            <button onclick="setCountdownPreset('11:15')">11:15 AM</button>
            <button onclick="setCountdownPreset('18:15')">6:15 PM</button>
        </div>
        <div class="form-group">
            <label for="customTime">Custom Time</label>
            <input type="time" id="customTime" style="width: auto;">
        </div>
        <button onclick="startCustomCountdown()">Start Countdown</button>
        <button onclick="stopCountdown()" class="hide">Stop Countdown</button>
    </div>
    
    <div class="container">
        <h2>Text Search</h2>
        <div class="form-group">
            <label for="searchInput">Search Bible</label>
            <input type="text" id="searchInput" placeholder="Search verses..." oninput="searchBible()">
        </div>
        <div class="search-results" id="searchResults" style="display: none;"></div>
    </div>

    <script>
        let ws;
        let selectedBook = '';
        let selectedChapter = 0;
        let selectedVerse = 0;
        let currentAutocompleteIndex = -1;
        let books = [];
        let speakers = [];
        let currentSpeakerIndex = -1;
        let currentBookData = null;
        let currentVerseData = null;
        let isAutoAdvanceActive = false;
        let nextVerseTextForMatching = '';
        let isNavigatingFromSuggestion = false;
        
        // Additional variables for consistency
        let currentBook = '';
        let currentChapter = 0;
        let currentVerse = 0;

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Toggle Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-mode');
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Toggle Dark Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                body.classList.remove('light-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Toggle Light Mode';
            } else {
                body.classList.add('light-mode');
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Toggle Dark Mode';
            }
        });

        // Navigation functions
        function previousVerse() {
            console.log('previousVerse called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse === 0) {
                console.log('Cannot go to previous verse - missing selection');
                return;
            }
            
            if (selectedVerse > 1) {
                // Previous verse in same chapter
                console.log('Going to previous verse in same chapter');
                selectVerse(selectedBook, selectedChapter, selectedVerse - 1);
            } else {
                console.log('At beginning of chapter');
            }
        }

        function nextVerse() {
            console.log('nextVerse called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse === 0) {
                console.log('Cannot go to next verse - missing selection');
                return;
            }
            
            // Request the next verse (server will handle chapter boundaries)
            console.log('Requesting next verse from server');
            
            // Send a special request to get the next verse
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_next_verse',
                    book: selectedBook,
                    chapter: selectedChapter,
                    verse: selectedVerse
                }));
            }
        }

        function previousVerse() {
            console.log('previousVerse called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse <= 1) {
                console.log('Cannot go to previous verse - at beginning or missing selection');
                return;
            }
            
            // Go to previous verse
            const prevVerseNum = selectedVerse - 1;
            console.log('Attempting to go to previous verse:', prevVerseNum);
            
            // Update the selection
            selectedVerse = prevVerseNum;
            currentVerse = prevVerseNum;
            
            // Update the verse selector
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.value = prevVerseNum;
            
            // Request the verse AND display it on OBS (not just preview)
            requestVerse(selectedBook, selectedChapter, prevVerseNum);
            
            // Also get preview for the client interface
            requestVersePreview(selectedBook, selectedChapter, prevVerseNum);
            
            updateNavigationButtons();
        }

        function selectVerse(book, chapter, verse) {
            console.log('selectVerse called:', { book, chapter, verse });
            
            selectedBook = book;
            selectedChapter = chapter;
            selectedVerse = verse;
            
            // Update global current variables
            currentBook = book;
            currentChapter = chapter;
            currentVerse = verse;
            
            // Find the book data
            const foundBook = books.find(b => b.abbrev === book || b.name === book);
            if (!foundBook) {
                console.error('Book not found:', book);
                return;
            }
            
            // Update the book input field
            const bookInput = document.getElementById('bookInput');
            bookInput.value = foundBook.name;
            
            // Update the chapter selector
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.value = chapter;
            chapterSelect.disabled = false;
            
            // Update the verse selector  
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.value = verse;
            verseSelect.disabled = false;
            
            // Request and preview the verse
            console.log('Requesting verse preview for:', foundBook.abbrev || foundBook.name, chapter, verse);
            requestVersePreview(foundBook.abbrev || foundBook.name, chapter, verse);
        }

        function extractBookFromName(verseName) {
            // Extract book name from verse name like "Genesis 1:2"
            if (verseName && verseName.includes(' ')) {
                const parts = verseName.split(' ');
                // Return everything except the last part (which is chapter:verse)
                return parts.slice(0, -1).join(' ');
            }
            return selectedBook; // Fallback to current book
        }

        function updateUIForNewVerse(book, chapter, verse) {
            // Update book input
            const foundBook = books.find(b => b.abbrev === book || b.name === book);
            if (foundBook) {
                const bookInput = document.getElementById('bookInput');
                bookInput.value = foundBook.name;
            }
            
            // Update chapter selector
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.value = chapter;
            chapterSelect.disabled = false;
            
            // Update verse selector
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.value = verse;
            verseSelect.disabled = false;
            
            // Update navigation buttons
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentRef = document.getElementById('currentVerseRef');
            
            console.log('updateNavigationButtons called:', {
                selectedBook,
                selectedChapter,
                selectedVerse
            });
            
            if (!selectedBook || selectedChapter === 0 || selectedVerse === 0) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                currentRef.textContent = 'Select a verse';
                console.log('Navigation buttons disabled - missing data');
                return;
            }
            
            // Update the current reference display
            currentRef.textContent = `Current: ${selectedBook} ${selectedChapter}:${selectedVerse}`;
            
            // Enable/disable buttons based on simple logic
            const canGoPrev = selectedVerse > 1;
            prevBtn.disabled = !canGoPrev;
            
            // Update button text to show next/previous verse numbers
            if (canGoPrev) {
                prevBtn.textContent = `‚Üê ${selectedBook} ${selectedChapter}:${selectedVerse - 1}`;
            } else {
                prevBtn.textContent = '‚Üê Previous Verse';
            }
            
            // For next button, always enable it and show next verse number
            nextBtn.disabled = false;
            nextBtn.textContent = `${selectedBook} ${selectedChapter}:${selectedVerse + 1} ‚Üí`;
            
            console.log('Navigation buttons updated:', {
                canGoPrev,
                prevDisabled: prevBtn.disabled,
                nextDisabled: nextBtn.disabled,
                nextVerse: selectedVerse + 1
            });
        }

        function connect() {
            ws = new WebSocket('ws://localhost:8080/ws/control');
            
            ws.onopen = function() {
                console.log('Connected to server');
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connected to server';
                
                // Load initial book list
                requestBooks();
                
                // Load speakers list
                requestSpeakers();
            };
            
            ws.onclose = function() {
                console.log('Disconnected from server');
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'Disconnected from server - Retrying...';
                setTimeout(connect, 3000);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'books_response':
                        handleBooksResponse(data.books);
                        break;
                    case 'chapters_response':
                        handleChaptersResponse(data.chapters);
                        break;
                    case 'verses_response':
                        handleVersesResponse(data.verses);
                        break;
                    case 'search_results':
                        handleSearchResults(data.results);
                        break;
                    case 'verse_preview':
                        if (data.verse) {
                            showVersePreview(data.verse);
                        } else {
                            console.log('Verse not found, cannot navigate further');
                            // Revert the verse selection if the verse doesn't exist
                            if (selectedVerse > 1) {
                                selectedVerse = selectedVerse - 1;
                                currentVerse = selectedVerse;
                                // Update the verse selector back
                                const verseSelect = document.getElementById('verseSelect');
                                verseSelect.value = selectedVerse;
                            }
                        }
                        break;
                    case 'next_verse_preview':
                        if (data.verse) {
                            showNextVersePreview(data.verse);
                        } else {
                            hideNextVersePreview();
                        }
                        break;
                    case 'next_verse_response':
                        if (data.verse) {
                            // Successfully got next verse, update our current selection
                            const verse = data.verse;
                            console.log('Received next verse:', verse);
                            
                            // Update selection variables
                            selectedBook = extractBookFromName(verse.name);
                            selectedChapter = verse.chapter;
                            selectedVerse = verse.verse;
                            currentBook = selectedBook;
                            currentChapter = selectedChapter;
                            currentVerse = selectedVerse;
                            
                            // Update UI selectors
                            updateUIForNewVerse(selectedBook, selectedChapter, selectedVerse);
                            
                            // Show verse preview
                            showVersePreview(verse);
                            
                            console.log('Navigation successful to:', selectedBook, selectedChapter, selectedVerse);
                        } else {
                            console.log('No next verse available (end of book?)');
                        }
                        break;
                    case 'speakers_response':
                        handleSpeakersResponse(data.speakers);
                        break;
                }
            };
        }

        function requestBooks(filter = '') {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_books',
                    filter: filter
                }));
            }
        }

        function requestChapters(book) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_chapters',
                    book: book
                }));
            }
        }

        function requestVerses(book, chapter) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_verses',
                    book: book,
                    chapter: chapter
                }));
            }
        }

        function requestVerse(book, chapter, verse) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_verse',
                    book: book,
                    chapter: chapter,
                    verse: verse
                }));
            }
        }

        function requestVersePreview(book, chapter, verse) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'preview_verse',
                    book: book,
                    chapter: chapter,
                    verse: verse
                }));
            }
        }

        function requestNextVersePreview(book, chapter, verse) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'preview_next_verse',
                    book: book,
                    chapter: chapter,
                    verse: verse
                }));
            }
        }

        function requestSpeakers(filter = '') {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_speakers',
                    filter: filter
                }));
            }
        }

        function handleBooksResponse(bookList) {
            books = bookList;
            showBookDropdown(bookList);
            
            // Handle pending quick selection
            if (pendingQuickSelection) {
                const { bookName, chapter, verse } = pendingQuickSelection;
                
                // Find matching book (case insensitive, flexible matching)
                const matchedBook = bookList.find(book => 
                    book.toLowerCase().includes(bookName.toLowerCase()) ||
                    bookName.toLowerCase().includes(book.toLowerCase())
                );
                
                if (matchedBook) {
                    // Set the book
                    selectedBook = matchedBook;
                    currentBook = matchedBook;
                    document.getElementById('bookInput').value = matchedBook;
                    
                    // Request chapters for this book
                    requestChapters(matchedBook);
                    
                    // Store the chapter and verse to select after chapters load
                    pendingQuickSelection = { ...pendingQuickSelection, bookName: matchedBook };
                } else {
                    const status = document.getElementById('quickVerseStatus');
                    if (status) {
                        status.innerHTML = `‚ùå Book "${bookName}" not found. Please check the spelling.`;
                        status.style.color = '#dc3545';
                    }
                    pendingQuickSelection = null;
                }
            }
        }

        function handleChaptersResponse(chapters) {
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.innerHTML = '<option value="">Select chapter</option>';
            
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
            
            chapterSelect.disabled = false;
            document.getElementById('verseSelect').disabled = true;
            document.getElementById('verseSelect').innerHTML = '<option value="">Select verse</option>';
            hideVersePreview();
            
            // Handle pending quick selection
            if (pendingQuickSelection) {
                const { chapter, verse } = pendingQuickSelection;
                
                // Check if the requested chapter exists
                if (chapters.includes(chapter)) {
                    // Set the chapter
                    selectedChapter = chapter;
                    currentChapter = chapter;
                    chapterSelect.value = chapter;
                    
                    // Request verses for this chapter
                    requestVerses(selectedBook, chapter);
                    
                    // Keep the verse selection for when verses load
                } else {
                    const status = document.getElementById('quickVerseStatus');
                    if (status) {
                        status.innerHTML = `‚ùå Chapter ${chapter} not found in ${selectedBook}.`;
                        status.style.color = '#dc3545';
                    }
                    pendingQuickSelection = null;
                }
            }
        }

        function handleVersesResponse(verses) {
            const verseSelect = document.getElementById('verseSelect');
            verseSelect.innerHTML = '<option value="">Select verse</option>';
            
            verses.forEach(verse => {
                const option = document.createElement('option');
                option.value = verse;
                option.textContent = verse;
                verseSelect.appendChild(option);
            });
            
            verseSelect.disabled = false;
            hideVersePreview();
            
            // Handle pending quick selection
            if (pendingQuickSelection) {
                const { verse } = pendingQuickSelection;
                const status = document.getElementById('quickVerseStatus');
                
                // Check if the requested verse exists
                if (verses.includes(verse)) {
                    // Set the verse
                    selectedVerse = verse;
                    currentVerse = verse;
                    verseSelect.value = verse;
                    
                    // Request the verse preview
                    requestVersePreview(selectedBook, selectedChapter, verse);
                    
                    // If navigating from a suggestion, don't clear the input. Otherwise, do.
                    if (!isNavigatingFromSuggestion) {
                        document.getElementById('quickVerseInput').value = '';
                        if (status) {
                            status.innerHTML = '‚úÖ Verse found and selected!';
                            status.style.color = '#28a745';
                            setTimeout(() => {
                                status.innerHTML = 'Format: BookName Chapter:Verse (e.g., "Genesis 1:16", "1 John 3:16", "Psalm 23:1")';
                                status.style.color = 'var(--text-color)';
                            }, 2000);
                        }
                    }

                    // Reset the flag after use
                    isNavigatingFromSuggestion = false;
                } else {
                    if (status) {
                        status.innerHTML = `‚ùå Verse ${verse} not found in ${selectedBook} ${selectedChapter}.`;
                        status.style.color = '#dc3545';
                    }
                }
                
                pendingQuickSelection = null;
            }
        }

        function handleSpeakersResponse(speakerList) {
            speakers = speakerList;
            showSpeakerDropdown(speakerList);
        }

        function showSpeakerDropdown(speakerList) {
            const dropdown = document.getElementById('speakerDropdown');
            dropdown.innerHTML = '';
            
            if (speakerList.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            speakerList.slice(0, 10).forEach((speaker, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = speaker;
                item.addEventListener('click', () => {
                    selectSpeaker(speaker);
                });
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
            currentSpeakerIndex = -1;
        }

        function selectSpeaker(speaker) {
            document.getElementById('speakerInput').value = speaker;
            document.getElementById('speakerDropdown').style.display = 'none';
            currentSpeakerIndex = -1;
        }

        function filterSpeakers() {
            const input = document.getElementById('speakerInput');
            const filter = input.value;
            
            if (filter.length > 0) {
                requestSpeakers(filter);
            } else {
                document.getElementById('speakerDropdown').style.display = 'none';
            }
        }

        function handleSpeakerKeydown(event) {
            const dropdown = document.getElementById('speakerDropdown');
            const items = dropdown.getElementsByClassName('autocomplete-item');
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                currentSpeakerIndex = Math.min(currentSpeakerIndex + 1, items.length - 1);
                updateSpeakerSelection(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                currentSpeakerIndex = Math.max(currentSpeakerIndex - 1, -1);
                updateSpeakerSelection(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (currentSpeakerIndex >= 0 && items[currentSpeakerIndex]) {
                    selectSpeaker(items[currentSpeakerIndex].textContent);
                }
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
                currentSpeakerIndex = -1;
            }
        }

        function updateSpeakerSelection(items) {
            Array.from(items).forEach((item, index) => {
                if (index === currentSpeakerIndex) {
                    item.style.backgroundColor = 'var(--button-bg)';
                    item.style.color = 'white';
                } else {
                    item.style.backgroundColor = '';
                    item.style.color = '';
                }
            });
        }

        function handleSearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (results.length > 0) {
                searchResults.style.display = 'block';
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'search-result';
                    
                    // Handle new structure where result.name contains the reference
                    let verseReference;
                    if (result.name) {
                        verseReference = result.name;
                    } else if (result.book) {
                        verseReference = `${result.book} ${result.chapter}:${result.verse}`;
                    } else {
                        verseReference = `Chapter ${result.chapter}:${result.verse}`;
                    }
                    
                    div.innerHTML = `
                        <div class="verse-reference">${verseReference}</div>
                        <div class="verse-text">${result.text}</div>
                    `;
                    div.onclick = () => selectSearchResult(result);
                    searchResults.appendChild(div);
                });
            } else {
                searchResults.style.display = 'none';
            }
        }

        function selectSearchResult(result) {
            // Extract book name from result.name (e.g., "John 3:16" -> "John")
            let bookName;
            if (result.name) {
                // Parse the book name from the reference string
                const parts = result.name.split(' ');
                // Handle cases like "I John 3:16", "II Peter 1:1", etc.
                if (parts.length >= 2 && (parts[0] === 'I' || parts[0] === 'II' || parts[0] === 'III')) {
                    bookName = parts[0] + ' ' + parts[1];
                } else {
                    bookName = parts[0];
                }
            } else if (result.book) {
                bookName = result.book;
            } else {
                console.error('No book name found in search result');
                return;
            }
            
            // Set the book, chapter, and verse selections
            document.getElementById('bookInput').value = bookName;
            selectedBook = bookName;
            currentBook = bookName;
            
            // Request chapters for this book
            requestChapters(bookName);
            
            // Set chapter and verse when chapters load
            setTimeout(() => {
                document.getElementById('chapterSelect').value = result.chapter;
                selectedChapter = result.chapter;
                currentChapter = result.chapter;
                
                // Request verses for this chapter
                requestVerses(bookName, result.chapter);
                
                // Set verse when verses load
                setTimeout(() => {
                    document.getElementById('verseSelect').value = result.verse;
                    selectedVerse = result.verse;
                    currentVerse = result.verse;
                    showVersePreview(result);
                    updateNavigationButtons();
                }, 100);
            }, 100);
            
            hideBookDropdown();
            document.getElementById('searchResults').style.display = 'none';
        }

        function showBookDropdown(bookList) {
            const dropdown = document.getElementById('bookDropdown');
            dropdown.innerHTML = '';
            
            bookList.forEach((book, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                if (index === currentAutocompleteIndex) {
                    div.classList.add('selected');
                }
                div.textContent = book;
                div.onclick = () => selectBook(book);
                dropdown.appendChild(div);
            });
            
            dropdown.style.display = bookList.length > 0 ? 'block' : 'none';
        }

        function hideBookDropdown() {
            document.getElementById('bookDropdown').style.display = 'none';
            currentAutocompleteIndex = -1;
        }

        function displayBookSuggestions(books) {
            const bookDropdown = document.getElementById('bookDropdown');
            if (books.length === 0) {
                bookDropdown.innerHTML = '<div class="dropdown-item">No books found</div>';
            } else {
                bookDropdown.innerHTML = books.map(book => 
                    `<div class="dropdown-item" onclick="selectBook('${book}')">${book}</div>`
                ).join('');
            }
            bookDropdown.style.display = 'block';
        }

        function selectBook(bookName) {
            console.log('Selecting book:', bookName); // Debug log
            if (!bookName || bookName === 'undefined') {
                console.error('Invalid book name:', bookName);
                return;
            }
            
            const bookDropdown = document.getElementById('bookDropdown');
            document.getElementById('bookInput').value = bookName;
            bookDropdown.style.display = 'none';
            
            currentBook = bookName;
            selectedBook = bookName;
            currentChapter = 0;
            selectedChapter = 0;
            currentVerse = 0;
            selectedVerse = 0;
            currentBookData = null;
            
            // Reset chapter and verse dropdowns
            document.getElementById('chapterSelect').innerHTML = '<option value="">Select Chapter</option>';
            document.getElementById('verseSelect').innerHTML = '<option value="">Select Verse</option>';
            
            // Request chapters for this book
            const message = {
                type: 'get_chapters',
                book: bookName
            };
            
            ws.send(JSON.stringify(message));
            updateNavigationButtons();
        }

        function showVersePreview(verse) {
            // Always show book, chapter, and verse information clearly
            let verseReference;
            let bookName = selectedBook;
            let chapterNum = verse.chapter || selectedChapter;
            let verseNum = verse.verse || selectedVerse;
            
            // Handle both old format (with book property) and new format (with name property)
            if (verse.name) {
                verseReference = verse.name; // Use the name field from new JSON structure
                // Extract book name from the name field if available
                const nameParts = verse.name.split(' ');
                if (nameParts.length >= 2) {
                    const refPart = nameParts[nameParts.length - 1]; // Get the last part (chapter:verse)
                    bookName = nameParts.slice(0, -1).join(' '); // Everything except the last part
                }
            } else if (verse.book) {
                verseReference = `${verse.book} ${chapterNum}:${verseNum}`;
                bookName = verse.book;
            } else {
                verseReference = `${bookName} ${chapterNum}:${verseNum}`;
            }
            
            // Store current verse data for display
            currentVerseData = verse;
            
            // Update the preview display with clear formatting
            document.getElementById('verseReference').textContent = verseReference;
            document.getElementById('verseText').textContent = verse.text;
            document.getElementById('versePreview').style.display = 'block';
            document.getElementById('displayBtn').disabled = false;
            
            // Update the current verse reference in navigation area
            const currentRef = document.getElementById('currentVerseRef');
            if (currentRef) {
                currentRef.textContent = `Current: ${bookName} ${chapterNum}:${verseNum}`;
            }
            
            console.log('Verse preview updated:', {
                reference: verseReference,
                book: bookName,
                chapter: chapterNum,
                verse: verseNum,
                text: verse.text.substring(0, 50) + '...'
            });
            
            // Update navigation buttons when verse is shown
            updateNavigationButtons();
            
            // Request next verse preview automatically
            if (selectedBook && selectedChapter && selectedVerse) {
                requestNextVersePreview(selectedBook, selectedChapter, selectedVerse);
            }
        }

        function hideVersePreview() {
            document.getElementById('versePreview').style.display = 'none';
            document.getElementById('displayBtn').disabled = true;
            hideNextVersePreview();
        }

        function showNextVersePreview(verse) {
            // Extract verse information
            let verseReference;
            let bookName = selectedBook;
            let chapterNum = verse.chapter || selectedChapter;
            let verseNum = verse.verse || selectedVerse;
            
            // Handle both old format (with book property) and new format (with name property)
            if (verse.name) {
                verseReference = verse.name;
                // Extract book name from the name field if available
                const nameParts = verse.name.split(' ');
                if (nameParts.length >= 2) {
                    const refPart = nameParts[nameParts.length - 1];
                    bookName = nameParts.slice(0, -1).join(' ');
                }
            } else if (verse.book) {
                verseReference = `${verse.book} ${chapterNum}:${verseNum}`;
                bookName = verse.book;
            } else {
                verseReference = `${bookName} ${chapterNum}:${verseNum}`;
            }
            
            // Store the next verse text for auto-advance matching
            nextVerseTextForMatching = verse.text;

            // Update the next verse preview display
            document.getElementById('nextVerseReference').textContent = verseReference;
            document.getElementById('nextVerseText').textContent = verse.text;
            document.getElementById('nextVersePreview').style.display = 'block';
            
            console.log('Next verse preview updated:', {
                reference: verseReference,
                text: verse.text.substring(0, 50) + '...'
            });
        }

        function hideNextVersePreview() {
            document.getElementById('nextVersePreview').style.display = 'none';
        }

        function searchBible() {
            const query = document.getElementById('searchInput').value;
            if (query.trim() && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'search',
                    query: query
                }));
            } else {
                document.getElementById('searchResults').style.display = 'none';
            }
        }

        function displayVerse() {
            if (selectedBook && selectedChapter && selectedVerse) {
                requestVerse(selectedBook, selectedChapter, selectedVerse);
            }
        }

        function hideVerse() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'bible',
                    show: false
                }));
            }
        }

        function displaySpeaker() {
            const speaker = document.getElementById('speakerInput').value;
            if (speaker && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'speaker',
                    speaker: speaker,
                    show: true
                }));
            }
        }

        function hideSpeaker() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'speaker',
                    show: false
                }));
            }
        }

        // Book input event handlers
        document.getElementById('bookInput').addEventListener('input', function() {
            const filter = this.value;
            currentAutocompleteIndex = -1;
            if (filter.trim()) {
                requestBooks(filter);
            } else {
                hideBookDropdown();
            }
        });

        document.getElementById('bookInput').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('bookDropdown');
            const items = dropdown.children;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentAutocompleteIndex = Math.min(currentAutocompleteIndex + 1, items.length - 1);
                updateDropdownSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentAutocompleteIndex = Math.max(currentAutocompleteIndex - 1, -1);
                updateDropdownSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentAutocompleteIndex >= 0 && items[currentAutocompleteIndex]) {
                    selectBook(items[currentAutocompleteIndex].textContent);
                }
            } else if (e.key === 'Escape') {
                hideBookDropdown();
            }
        });

        document.getElementById('bookInput').addEventListener('blur', function() {
            // Delay hiding to allow click events
            setTimeout(hideBookDropdown, 100);
        });

        function updateDropdownSelection() {
            const items = document.getElementById('bookDropdown').children;
            for (let i = 0; i < items.length; i++) {
                items[i].classList.toggle('selected', i === currentAutocompleteIndex);
            }
        }

        // Chapter select handler
        document.getElementById('chapterSelect').addEventListener('change', function() {
            selectedChapter = parseInt(this.value);
            currentChapter = selectedChapter;
            selectedVerse = 0; // Reset verse selection
            currentVerse = 0;
            if (selectedChapter && selectedBook) {
                requestVerses(selectedBook, selectedChapter);
            } else {
                document.getElementById('verseSelect').disabled = true;
                document.getElementById('verseSelect').innerHTML = '<option value="">Select verse</option>';
                hideVersePreview();
            }
            updateNavigationButtons();
        });

        // Verse select handler  
        document.getElementById('verseSelect').addEventListener('change', function() {
            selectedVerse = parseInt(this.value);
            currentVerse = selectedVerse;
            if (selectedVerse && selectedBook && selectedChapter) {
                // Request the actual verse text for preview
                requestVersePreview(selectedBook, selectedChapter, selectedVerse);
                updateNavigationButtons();
            } else {
                hideVersePreview();
                updateNavigationButtons();
            }
        });

        // Quick verse input functions
        let quickVerseAutocompleteIndex = -1;
        let quickVerseSuggestions = [];
        
        function handleQuickVerseKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (quickVerseAutocompleteIndex >= 0 && quickVerseSuggestions.length > 0) {
                    selectQuickVerseSuggestion(quickVerseSuggestions[quickVerseAutocompleteIndex]);
                } else {
                    parseQuickVerse();
                }
            }
        }

        function handleQuickVerseKeydown(event) {
            const dropdown = document.getElementById('quickVerseDropdown');
            if (dropdown.style.display === 'block') {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    quickVerseAutocompleteIndex = Math.min(quickVerseAutocompleteIndex + 1, quickVerseSuggestions.length - 1);
                    updateQuickVerseSelection();
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    quickVerseAutocompleteIndex = Math.max(quickVerseAutocompleteIndex - 1, -1);
                    updateQuickVerseSelection();
                } else if (event.key === 'Escape') {
                    hideQuickVerseDropdown();
                }
            }
        }

        function handleQuickVerseInput(event) {
            const input = event.target.value;
            const status = document.getElementById('quickVerseStatus');
            const goBtn = document.getElementById('quickVerseGoBtn');
            
            // Real-time validation and autocomplete
            if (!input.trim()) {
                status.innerHTML = 'Format: BookName Chapter:Verse (e.g., "Genesis 1:16", "1 John 3:16", "Psalm 23:1")';
                status.style.color = 'var(--text-color)';
                goBtn.disabled = false;
                hideQuickVerseDropdown();
                return;
            }

            // Check for valid characters only (letters, numbers, spaces, colon)
            const validChars = /^[a-zA-Z0-9\s:]*$/;
            if (!validChars.test(input)) {
                status.innerHTML = '‚ùå Only letters, numbers, spaces, and colon (:) allowed';
                status.style.color = '#dc3545';
                goBtn.disabled = true;
                hideQuickVerseDropdown();
                return;
            }

            // Parse current input state
            const colonIndex = input.indexOf(':');
            const lastSpaceIndex = input.lastIndexOf(' ');
            
            if (colonIndex === -1) {
                // Still typing book name or chapter
                if (lastSpaceIndex === -1) {
                    // Still typing book name
                    showBookSuggestions(input);
                    status.innerHTML = 'üí° Type book name... (e.g., Genesis, John, Psalm)';
                    status.style.color = 'var(--button-bg)';
                    goBtn.disabled = true;
                } else {
                    // Has space, might be typing chapter
                    const bookPart = input.substring(0, lastSpaceIndex);
                    const chapterPart = input.substring(lastSpaceIndex + 1);
                    
                    if (!/^\d*$/.test(chapterPart)) {
                        status.innerHTML = '‚ùå Chapter must be a number';
                        status.style.color = '#dc3545';
                        goBtn.disabled = true;
                        hideQuickVerseDropdown();
                    } else {
                        showBookSuggestions(bookPart);
                        status.innerHTML = `üí° Add colon and verse number (e.g., "${input}:1")`;
                        status.style.color = 'var(--button-bg)';
                        goBtn.disabled = true;
                    }
                }
            } else {
                // Has colon, check verse number
                const beforeColon = input.substring(0, colonIndex);
                const afterColon = input.substring(colonIndex + 1);
                
                if (!/^\d*$/.test(afterColon)) {
                    status.innerHTML = '‚ùå Verse must be a number';
                    status.style.color = '#dc3545';
                    goBtn.disabled = true;
                } else if (afterColon === '') {
                    status.innerHTML = 'üí° Type verse number';
                    status.style.color = 'var(--button-bg)';
                    goBtn.disabled = true;
                } else {
                    // Valid format
                    const regex = /^(.+?)\s+(\d+):(\d+)$/;
                    if (regex.test(input)) {
                        status.innerHTML = '‚úÖ Valid format! Press Enter or click Go';
                        status.style.color = '#28a745';
                        goBtn.disabled = false;
                    } else {
                        status.innerHTML = 'üí° Almost there... (BookName Chapter:Verse)';
                        status.style.color = 'var(--button-bg)';
                        goBtn.disabled = true;
                    }
                }
                hideQuickVerseDropdown();
            }
        }

        function showBookSuggestions(input) {
            if (!books || books.length === 0 || !input.trim()) {
                hideQuickVerseDropdown();
                return;
            }

            const filter = input.toLowerCase().trim();
            const suggestions = books.filter(book => 
                book.toLowerCase().includes(filter)
            ).slice(0, 8); // Show max 8 suggestions

            if (suggestions.length === 0) {
                hideQuickVerseDropdown();
                return;
            }

            quickVerseSuggestions = suggestions;
            quickVerseAutocompleteIndex = -1;
            
            const dropdown = document.getElementById('quickVerseDropdown');
            dropdown.innerHTML = '';
            
            suggestions.forEach((book, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = book;
                item.addEventListener('click', () => selectQuickVerseSuggestion(book));
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        function selectQuickVerseSuggestion(book) {
            const input = document.getElementById('quickVerseInput');
            const currentValue = input.value;
            const lastSpaceIndex = currentValue.lastIndexOf(' ');
            
            if (lastSpaceIndex === -1) {
                // Replace entire input with book name
                input.value = book + ' ';
            } else {
                // Replace just the book part
                const afterSpace = currentValue.substring(lastSpaceIndex + 1);
                if (/^\d/.test(afterSpace)) {
                    // Keep the chapter part
                    input.value = book + ' ' + afterSpace;
                } else {
                    // Replace the partial book name
                    input.value = book + ' ';
                }
            }
            
            hideQuickVerseDropdown();
            input.focus();
            
            // Trigger input event to update validation
            const event = new Event('input', { bubbles: true });
            input.dispatchEvent(event);
        }

        function updateQuickVerseSelection() {
            const items = document.getElementById('quickVerseDropdown').children;
            for (let i = 0; i < items.length; i++) {
                items[i].classList.toggle('selected', i === quickVerseAutocompleteIndex);
            }
        }

        function hideQuickVerseDropdown() {
            document.getElementById('quickVerseDropdown').style.display = 'none';
            quickVerseAutocompleteIndex = -1;
            quickVerseSuggestions = [];
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const quickInput = document.getElementById('quickVerseInput');
            const quickDropdown = document.getElementById('quickVerseDropdown');
            if (!quickInput.contains(event.target) && !quickDropdown.contains(event.target)) {
                hideQuickVerseDropdown();
            }
        });

        function parseQuickVerse() {
            const input = document.getElementById('quickVerseInput').value.trim();
            const status = document.getElementById('quickVerseStatus');
            
            if (!input) return;

            // Parse different formats like "Genesis 1:16", "1 John 3:16", "Psalm 23:1"
            const regex = /^(.+?)\s+(\d+):(\d+)$/;
            const match = input.match(regex);
            
            if (!match) {
                status.innerHTML = '‚ùå Please use format: BookName Chapter:Verse (e.g., "Genesis 1:16")';
                status.style.color = '#dc3545';
                return;
            }

            const bookName = match[1].trim();
            const chapter = parseInt(match[2]);
            const verse = parseInt(match[3]);

            // Show loading status
            status.innerHTML = 'üîç Searching for verse...';
            status.style.color = 'var(--button-bg)';

            // Set the selections
            selectBookByName(bookName, chapter, verse);
        }

        function selectBookByName(bookName, chapter, verse) {
            // First, request all books to find a match
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_books',
                    filter: ''
                }));
                
                // Store the target for when books are received
                pendingQuickSelection = { bookName, chapter, verse };
            }
        }

        let pendingQuickSelection = null;

        // Sermon Suggestion Feature
        let recognition = null;
        let isListening = false;
        let recentTranscription = '';
        let suggestionKeywords = new Map();
        let lastSuggestionUpdate = 0;
        let suggestionHistory = []; // Track suggestions with timestamps
        let maxSuggestionHistory = 10; // Keep last 10 suggestions
        let timestampUpdateInterval = null; // For updating timestamps
        
        // Common biblical terms and their associated verses
        const biblicalKeywords = {
            'love': ['1 Corinthians 13:4', 'John 3:16', '1 John 4:8'],
            'faith': ['Hebrews 11:1', 'Romans 10:17', 'Ephesians 2:8'],
            'hope': ['Romans 15:13', 'Hebrews 6:19', '1 Peter 1:3'],
            'peace': ['John 14:27', 'Philippians 4:7', 'Isaiah 26:3'],
            'joy': ['Nehemiah 8:10', 'Philippians 4:4', 'Psalm 16:11'],
            'prayer': ['1 Thessalonians 5:17', 'Matthew 6:9', 'James 5:16'],
            'forgiveness': ['Ephesians 4:32', '1 John 1:9', 'Matthew 6:14'],
            'salvation': ['Romans 10:9', 'Ephesians 2:8', 'Acts 4:12'],
            'grace': ['Ephesians 2:8', '2 Corinthians 12:9', 'Romans 6:14'],
            'wisdom': ['Proverbs 3:5', 'James 1:5', '1 Corinthians 1:30'],
            'strength': ['Philippians 4:13', 'Isaiah 40:31', '2 Corinthians 12:9'],
            'comfort': ['2 Corinthians 1:3', 'Psalm 23:4', 'Matthew 11:28'],
            'healing': ['Jeremiah 17:14', '1 Peter 2:24', 'Psalm 103:3'],
            'blessing': ['Numbers 6:24', 'Ephesians 1:3', 'Psalm 1:1'],
            'mercy': ['Lamentations 3:22', 'Psalm 23:6', 'Ephesians 2:4'],
            'truth': ['John 14:6', 'John 8:32', 'Psalm 119:160'],
            'light': ['John 8:12', 'Matthew 5:14', 'Psalm 119:105'],
            'kingdom': ['Matthew 6:33', 'Mark 1:15', 'Luke 17:21'],
            'shepherd': ['Psalm 23:1', 'John 10:11', 'Ezekiel 34:11'],
            'resurrection': ['1 Corinthians 15:20', 'John 11:25', 'Romans 6:5'],
            'eternal': ['John 3:16', '1 John 5:13', 'Romans 6:23'],
            'cross': ['1 Corinthians 1:18', 'Galatians 6:14', 'Luke 9:23'],
            'blood': ['1 John 1:7', 'Hebrews 9:22', 'Revelation 1:5'],
            'glory': ['Romans 3:23', '2 Corinthians 3:18', '1 Corinthians 10:31'],
            'heaven': ['Matthew 5:3', 'Revelation 21:4', '2 Corinthians 5:1'],
            'righteousness': ['Romans 3:22', '2 Corinthians 5:21', 'Matthew 5:6'],
            'holy': ['1 Peter 1:16', 'Leviticus 11:44', 'Isaiah 6:3'],
            'worship': ['John 4:24', 'Psalm 95:6', 'Romans 12:1']
        };

        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('Speech recognition not supported');
                document.getElementById('listenBtn').disabled = true;
                document.getElementById('listeningStatus').innerHTML = 'Speech recognition not supported in this browser.<br><small>Try Chrome, Edge, or Brave (with shields down)</small>';
                return false;
            }

            // Check if this is Brave browser
            const isBrave = navigator.userAgent.includes('Brave') || (navigator.brave && navigator.brave.isBrave);
            if (isBrave) {
                document.getElementById('listeningStatus').innerHTML = 'Brave browser detected. You may need to:<br><small>1. Allow microphone access<br>2. Disable Brave shields for this site</small>';
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                console.log('Speech recognition started');
                document.getElementById('listeningStatus').innerHTML = '<span class="listening-indicator"></span>Listening to sermon...';
                document.getElementById('transcriptionBox').style.display = 'block';
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const currentTranscript = finalTranscript + interimTranscript;
                document.getElementById('transcriptionText').textContent = currentTranscript;
                
                if (finalTranscript) {
                    recentTranscription += finalTranscript + ' ';
                    // Keep only last 200 words to prevent memory issues
                    const words = recentTranscription.split(' ');
                    if (words.length > 200) {
                        recentTranscription = words.slice(-200).join(' ');
                    }
                    
                    // Throttle suggestions to once every 2 seconds
                    const now = Date.now();
                    if (now - lastSuggestionUpdate > 2000) {
                        updateSuggestions();
                        lastSuggestionUpdate = now;
                    }

                    // Check for auto-advance trigger
                    if (isAutoAdvanceActive && nextVerseTextForMatching) {
                        const recentWords = new Set(recentTranscription.toLowerCase().split(' ').slice(-10));
                        const nextVerseWords = nextVerseTextForMatching.toLowerCase().split(' ').slice(0, 3);

                        let matchCount = 0;
                        for (const word of nextVerseWords) {
                            if (recentWords.has(word.replace(/[^\w\s]/gi, ''))) {
                                matchCount++;
                            }
                        }

                        // Require at least 2 of the first 3 words to match for higher speed
                        if (nextVerseWords.length > 0 && matchCount >= 2) {
                            console.log(`Auto-advancing to next verse (matched ${matchCount}/${nextVerseWords.length} words)...`);
                            nextVerse();
                            nextVerseTextForMatching = ''; // Clear after advancing
                        }
                    }
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    document.getElementById('listeningStatus').innerHTML = 'Microphone access denied.<br><small>Please allow microphone access and try again.</small>';
                } else if (event.error === 'no-speech') {
                    document.getElementById('listeningStatus').innerHTML = 'No speech detected.<br><small>Make sure your microphone is working and try again.</small>';
                } else {
                    document.getElementById('listeningStatus').innerHTML = `Error: ${event.error}<br><small>Check microphone permissions and browser settings.</small>`;
                }
            };

            recognition.onend = function() {
                if (isListening) {
                    // Restart recognition if it stops unexpectedly
                    setTimeout(() => {
                        if (isListening) {
                            recognition.start();
                        }
                    }, 1000);
                }
            };

            return true;
        }

        function toggleListening() {
            if (!recognition && !initializeSpeechRecognition()) {
                return;
            }

            const btn = document.getElementById('listenBtn');
            const status = document.getElementById('listeningStatus');

            if (isListening) {
                // Stop listening
                isListening = false;
                recognition.stop();
                btn.textContent = 'üé§ Start Listening';
                status.textContent = 'Stopped listening';
                document.getElementById('transcriptionBox').style.display = 'none';
                document.getElementById('suggestionsList').style.display = 'none';
                stopTimestampUpdates();
            } else {
                // Start listening
                isListening = true;
                recentTranscription = '';
                suggestionKeywords.clear();
                suggestionHistory = []; // Clear suggestion history
                
                try {
                    recognition.start();
                    btn.textContent = '‚èπÔ∏è Stop Listening';
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    isListening = false;
                    btn.textContent = 'üé§ Start Listening';
                    status.textContent = 'Error starting speech recognition';
                }
            }
        }

        function testMicrophone() {
            if (!recognition && !initializeSpeechRecognition()) {
                return;
            }

            const testBtn = document.getElementById('testMicBtn');
            const status = document.getElementById('listeningStatus');
            
            if (isListening) {
                status.innerHTML = 'Please stop listening first before testing microphone.';
                return;
            }

            testBtn.textContent = 'üîÑ Testing...';
            testBtn.disabled = true;
            status.innerHTML = 'Testing microphone... Say something!';

            const testRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            testRecognition.continuous = false;
            testRecognition.interimResults = false;
            testRecognition.lang = 'en-US';

            let testTimeout = setTimeout(() => {
                testRecognition.stop();
                testBtn.textContent = 'üîç Test Mic';
                testBtn.disabled = false;
                status.innerHTML = 'Test timeout - no speech detected.<br><small>Check microphone permissions and volume.</small>';
            }, 5000);

            testRecognition.onresult = function(event) {
                clearTimeout(testTimeout);
                const transcript = event.results[0][0].transcript;
                testBtn.textContent = 'üîç Test Mic';
                testBtn.disabled = false;
                status.innerHTML = `‚úÖ Microphone working! Heard: "${transcript}"<br><small>You can now start listening to the sermon.</small>`;
            };

            testRecognition.onerror = function(event) {
                clearTimeout(testTimeout);
                testBtn.textContent = 'üîç Test Mic';
                testBtn.disabled = false;
                status.innerHTML = `‚ùå Test failed: ${event.error}<br><small>Check microphone permissions.</small>`;
            };

            testRecognition.start();
        }

        function updateSuggestions() {
            const text = recentTranscription.toLowerCase();
            const words = text.split(/\s+/);
            const recentWords = words.slice(-50); // Look at last 50 words
            const currentTime = Date.now();
            
            // Count keyword occurrences
            suggestionKeywords.clear();
            
            for (const word of recentWords) {
                const cleanWord = word.replace(/[^\w]/g, ''); // Remove punctuation
                if (biblicalKeywords[cleanWord]) {
                    suggestionKeywords.set(cleanWord, (suggestionKeywords.get(cleanWord) || 0) + 1);
                }
            }

            // Add keyword-based suggestions to history
            for (const [keyword, count] of suggestionKeywords.entries()) {
                const verses = biblicalKeywords[keyword];
                if (!verses) continue;
                
                // Add top 2 verses for this keyword
                for (let i = 0; i < Math.min(2, verses.length); i++) {
                    const verse = verses[i];
                    
                    // Check if this verse suggestion already exists recently
                    const existingIndex = suggestionHistory.findIndex(s => 
                        s.verse === verse && (currentTime - s.timestamp) < 60000 // 1 minute
                    );
                    
                    if (existingIndex === -1) {
                        // New keyword suggestion
                        const suggestion = {
                            type: 'keyword',
                            text: verse,
                            verse: verse,
                            keyword: keyword,
                            count: count,
                            timestamp: currentTime,
                            priority: 500 + count * 10 // Lower priority than direct references
                        };
                        
                        // Insert based on priority but keep newer items first for same priority
                        let insertIndex = suggestionHistory.findIndex(s => s.priority < suggestion.priority);
                        if (insertIndex === -1) insertIndex = suggestionHistory.length;
                        
                        suggestionHistory.splice(insertIndex, 0, suggestion);
                    } else {
                        // Update existing suggestion
                        suggestionHistory[existingIndex].count = count;
                        suggestionHistory[existingIndex].timestamp = currentTime;
                        suggestionHistory[existingIndex].priority = 500 + count * 10;
                    }
                }
            }

            // Also detect direct Bible references in recent transcription
            detectBibleReferences();

            // Keep only recent suggestions (last 5 minutes)
            const fiveMinutesAgo = currentTime - (5 * 60 * 1000);
            suggestionHistory = suggestionHistory.filter(s => s.timestamp > fiveMinutesAgo);

            // Limit total suggestions
            if (suggestionHistory.length > maxSuggestionHistory) {
                suggestionHistory = suggestionHistory.slice(0, maxSuggestionHistory);
            }

            displaySuggestions();
        }

        function detectBibleReferences() {
            const text = recentTranscription;
            const currentTime = Date.now();
            
            // More comprehensive patterns for Bible references
            const patterns = [
                // Full reference with verse: "John 3:16", "1 Corinthians 13:4", "2 Timothy 3:16"
                /\b(\d?\s*(?:John|Matthew|Mark|Luke|Acts|Romans|Corinthians|Galatians|Ephesians|Philippians|Colossians|Thessalonians|Timothy|Titus|Philemon|Hebrews|James|Peter|Jude|Revelation|Genesis|Exodus|Leviticus|Numbers|Deuteronomy|Joshua|Judges|Ruth|Samuel|Kings|Chronicles|Ezra|Nehemiah|Esther|Job|Psalms?|Proverbs|Ecclesiastes|Song of Songs|Isaiah|Jeremiah|Lamentations|Ezekiel|Daniel|Hosea|Joel|Amos|Obadiah|Jonah|Micah|Nahum|Habakkuk|Zephaniah|Haggai|Zechariah|Malachi))\s+(\d+):(\d+)(?:-(\d+))?\b/gi,
                
                // Book and chapter: "Psalm 23", "Genesis 1", "1 Timothy 4"
                /\b(\d?\s*(?:John|Matthew|Mark|Luke|Acts|Romans|Corinthians|Galatians|Ephesians|Philippians|Colossians|Thessalonians|Timothy|Titus|Philemon|Hebrews|James|Peter|Jude|Revelation|Genesis|Exodus|Leviticus|Numbers|Deuteronomy|Joshua|Judges|Ruth|Samuel|Kings|Chronicles|Ezra|Nehemiah|Esther|Job|Psalms?|Proverbs|Ecclesiastes|Song of Songs|Isaiah|Jeremiah|Lamentations|Ezekiel|Daniel|Hosea|Joel|Amos|Obadiah|Jonah|Micah|Nahum|Habakkuk|Zephaniah|Haggai|Zechariah|Malachi))\s+(\d+)\b(?!\s*:\d+)/gi,
                
                // Just book name (most common ones)
                /\b(Genesis|Exodus|Psalms?|Proverbs|Isaiah|Jeremiah|Matthew|Mark|Luke|John|Acts|Romans|Corinthians|Galatians|Ephesians|Philippians|Colossians|Hebrews|James|Revelation)\b/gi
            ];

            const detectedRefs = new Set();
            
            patterns.forEach((pattern, index) => {
                let match;
                const matches = [...text.matchAll(pattern)];
                
                for (const match of matches) {
                    if (index === 0) {
                        // Full reference with verse (and possibly verse range)
                        const refObj = {
                            type: 'verse',
                            text: match[0],
                            book: match[1].trim(),
                            chapter: parseInt(match[2]),
                            verse: parseInt(match[3]),
                            timestamp: currentTime,
                            priority: 1000
                        };
                        if (match[4]) {
                            refObj.endVerse = parseInt(match[4]);
                            refObj.text = `${match[1].trim()} ${match[2]}:${match[3]}-${match[4]}`;
                        }
                        detectedRefs.add(JSON.stringify(refObj));
                    } else if (index === 1) {
                        // Book and chapter only
                        const refObj = {
                            type: 'chapter',
                            text: match[0],
                            book: match[1].trim(),
                            chapter: parseInt(match[2]),
                            timestamp: currentTime,
                            priority: 999
                        };
                        detectedRefs.add(JSON.stringify(refObj));
                    } else {
                        // Book name only
                        const refObj = {
                            type: 'book',
                            text: match[0],
                            book: match[0].trim(),
                            timestamp: currentTime,
                            priority: 998
                        };
                        detectedRefs.add(JSON.stringify(refObj));
                    }
                }
            });

            // Add detected references to suggestion history
            for (const refStr of detectedRefs) {
                const ref = JSON.parse(refStr);
                
                // Check if this reference was already detected recently (within 30 seconds)
                const existingIndex = suggestionHistory.findIndex(s => 
                    s.text === ref.text && (currentTime - s.timestamp) < 30000
                );
                
                if (existingIndex === -1) {
                    // New suggestion - add to history
                    suggestionHistory.unshift(ref);
                    
                    // Keep only the most recent suggestions
                    if (suggestionHistory.length > maxSuggestionHistory) {
                        suggestionHistory = suggestionHistory.slice(0, maxSuggestionHistory);
                    }
                } else {
                    // Update timestamp of existing suggestion and move to front
                    suggestionHistory[existingIndex].timestamp = currentTime;
                    const updated = suggestionHistory.splice(existingIndex, 1)[0];
                    suggestionHistory.unshift(updated);
                }
            }
        }

        function displaySuggestions() {
            const suggestionsContainer = document.getElementById('suggestions');
            const suggestionsList = document.getElementById('suggestionsList');
            
            if (suggestionHistory.length === 0) {
                suggestionsList.style.display = 'none';
                stopTimestampUpdates();
                return;
            }

            suggestionsList.style.display = 'block';
            suggestionsContainer.innerHTML = '';

            // Sort suggestions by timestamp (newest first) then by priority
            const sortedSuggestions = [...suggestionHistory]
                .sort((a, b) => {
                    // First by priority (higher priority first)
                    if (a.priority !== b.priority) {
                        return b.priority - a.priority;
                    }
                    // Then by timestamp (newer first)
                    return b.timestamp - a.timestamp;
                })
                .slice(0, 8); // Show top 8 suggestions

            for (const suggestion of sortedSuggestions) {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'suggestion-item';
                suggestionDiv.setAttribute('data-timestamp', suggestion.timestamp);
                
                // Calculate how recent this suggestion is
                const timeText = getTimeAgoText(suggestion.timestamp);

                if (suggestion.type === 'verse' || suggestion.type === 'chapter' || suggestion.type === 'book') {
                    // Direct Bible reference from speech
                    suggestionDiv.classList.add('suggestion-direct-reference');
                    
                    if (suggestion.type === 'verse') {
                        suggestionDiv.onclick = () => navigateToVerse(`${suggestion.book} ${suggestion.chapter}:${suggestion.verse}`);
                        suggestionDiv.innerHTML = `
                            <div class="suggestion-ref">üìñ ${suggestion.text}</div>
                            <div class="suggestion-keywords">üé§ Verse mentioned <span class="timestamp">${timeText}</span> - click to display</div>
                        `;
                    } else if (suggestion.type === 'chapter') {
                        suggestionDiv.onclick = () => navigateToChapter(suggestion.book, suggestion.chapter);
                        suggestionDiv.innerHTML = `
                            <div class="suggestion-ref">üìñ ${suggestion.text}</div>
                            <div class="suggestion-keywords">üé§ Chapter mentioned <span class="timestamp">${timeText}</span> - click to display</div>
                        `;
                    } else {
                        suggestionDiv.onclick = () => navigateToBook(suggestion.book);
                        suggestionDiv.innerHTML = `
                            <div class="suggestion-ref">üìñ ${suggestion.text}</div>
                            <div class="suggestion-keywords">üé§ Book mentioned <span class="timestamp">${timeText}</span> - click to display</div>
                        `;
                    }
                } else if (suggestion.type === 'keyword') {
                    // Keyword-based suggestion
                    suggestionDiv.classList.add('suggestion-keyword-based');
                    suggestionDiv.onclick = () => navigateToVerse(suggestion.verse);
                    suggestionDiv.innerHTML = `
                        <div class="suggestion-ref">${suggestion.verse}</div>
                        <div class="suggestion-keywords">Related to: "${suggestion.keyword}" (${suggestion.count} time${suggestion.count > 1 ? 's' : ''}) ‚Ä¢ <span class="timestamp">${timeText}</span></div>
                    `;
                }
                
                suggestionsContainer.appendChild(suggestionDiv);
            }

            // Start timestamp updates if we have suggestions
            if (sortedSuggestions.length > 0) {
                startTimestampUpdates();
            }
        }

        function getTimeAgoText(timestamp) {
            const secondsAgo = Math.floor((Date.now() - timestamp) / 1000);
            if (secondsAgo < 60) {
                return `${secondsAgo}s ago`;
            } else if (secondsAgo < 3600) {
                return `${Math.floor(secondsAgo / 60)}m ago`;
            } else {
                return `${Math.floor(secondsAgo / 3600)}h ago`;
            }
        }

        function updateTimestamps() {
            const timestampElements = document.querySelectorAll('#suggestions .timestamp');
            const suggestionItems = document.querySelectorAll('#suggestions .suggestion-item');
            
            suggestionItems.forEach((item, index) => {
                const timestamp = parseInt(item.getAttribute('data-timestamp'));
                if (timestamp && timestampElements[index]) {
                    timestampElements[index].textContent = getTimeAgoText(timestamp);
                }
            });
        }

        function startTimestampUpdates() {
            if (timestampUpdateInterval) {
                clearInterval(timestampUpdateInterval);
            }
            
            // Update timestamps every 10 seconds
            timestampUpdateInterval = setInterval(updateTimestamps, 10000);
        }

        function stopTimestampUpdates() {
            if (timestampUpdateInterval) {
                clearInterval(timestampUpdateInterval);
                timestampUpdateInterval = null;
            }
        }

        function navigateToVerse(verseRef) {
            // Parse the verse reference (e.g., "John 3:16")
            const match = verseRef.match(/^(.+?)\s+(\d+):(\d+)$/);
            if (!match) return;

            const bookName = match[1];
            const chapter = parseInt(match[2]);
            const verse = parseInt(match[3]);

            // Set flag to indicate navigation is from a suggestion
            isNavigatingFromSuggestion = true;

            // Immediately display the verse on OBS for a fast user experience
            requestVerse(bookName, chapter, verse);

            // Use the existing quick verse input functionality to sync the UI
            const quickInput = document.getElementById('quickVerseInput');
            quickInput.value = verseRef;
            
            // Trigger the selection process to update the UI (dropdowns, preview, etc.)
            selectBookByName(bookName, chapter, verse);
            
            // Show feedback
            const status = document.getElementById('quickVerseStatus');
            status.innerHTML = `üìñ Displaying ${verseRef} from suggestion...`;
            status.style.color = 'var(--button-bg)';
        }

        function navigateToChapter(bookName, chapter) {
            // Navigate to a specific chapter and display verse 1 immediately
            navigateToVerse(`${bookName} ${chapter}:1`);
        }

        function navigateToBook(bookName) {
            // Navigate to a book and display chapter 1, verse 1 immediately
            navigateToVerse(`${bookName} 1:1`);
        }

        function toggleAutoAdvance() {
            isAutoAdvanceActive = !isAutoAdvanceActive;
            const btn = document.getElementById('autoAdvanceBtn');
            if (isAutoAdvanceActive) {
                btn.classList.add('active');
                btn.textContent = 'Auto-Advance: ON';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Auto-Advance';
            }
        }

        // Initialize speech recognition when page loads
        window.addEventListener('DOMContentLoaded', function() {
            initializeSpeechRecognition();
        });

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function() {
            stopTimestampUpdates();
        });

        function setCountdownPreset(time) {
            document.getElementById('customTime').value = time;
            startCustomCountdown();
        }

        function startCustomCountdown() {
            const timeInput = document.getElementById('customTime').value;
            if (!timeInput) {
                alert('Please select a time.');
                return;
            }

            const [hours, minutes] = timeInput.split(':');
            const targetTime = new Date();
            targetTime.setHours(hours);
            targetTime.setMinutes(minutes);
            targetTime.setSeconds(0);
            targetTime.setMilliseconds(0);

            // If the time is in the past, set it for the next day
            if (targetTime < new Date()) {
                targetTime.setDate(targetTime.getDate() + 1);
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'countdown',
                    targetTime: targetTime.getTime(),
                    running: true
                }));
            }
        }

        function stopCountdown() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'countdown',
                    running: false
                }));
            }
        }

        // Connect on page load
        connect();
    </script>
</body>
</html>
